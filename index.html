<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Donaciones Pocket Ants v3.7</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f0f9f1 0%, #e6f7ee 100%);
            color: #333;
            padding-top: clamp(8px, 2vw, 12px);
            padding-bottom: clamp(8px, 2vw, 12px);
            padding-left: 3mm;
            padding-right: 3mm;
            margin: 0 auto;
            min-height: 100vh;
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
            font-weight: 700;
            /* Make all text bold */
        }

        .container {
            width: 100%;
            max-width: 100%;
            /* Allow it to fill the available space */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: clamp(8px, 2vw, 12px);
        }

        /* Header principal */
        .header {
            background: linear-gradient(135deg, #1a8c42 0%, #2db75e 100%);
            color: white;
            padding: clamp(12px, 3vw, 16px);
            border-radius: clamp(10px, 2.5vw, 14px);
            box-shadow: 0 4px 12px rgba(26, 140, 66, 0.3);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
            transform: rotate(30deg);
        }

        .header h1 {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(6px, 1.5vw, 8px);
            font-size: clamp(16px, 4.5vw, 19px);
            font-weight: 700;
            position: relative;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .header-subtitle {
            font-size: clamp(10px, 2.5vw, 12px);
            font-weight: 500;
            opacity: 0.9;
            margin-top: 4px;
            text-align: center;
        }

        .version-tag {
            position: absolute;
            bottom: 6px;
            right: 12px;
            font-size: clamp(9px, 2vw, 11px);
            opacity: 0.9;
            font-weight: 600;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Botones de acci√≥n */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: clamp(8px, 2vw, 10px);
            width: 100%;
        }

        .btn {
            padding: clamp(8px, 2vw, 10px) clamp(10px, 2.5vw, 12px);
            border-radius: clamp(10px, 2.5vw, 12px);
            color: white;
            font-weight: 600;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(2px, 0.5vw, 4px);
            font-size: clamp(11px, 2.5vw, 14px);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            min-height: clamp(32px, 8vw, 40px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            border: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-manual {
            background: linear-gradient(135deg, #8e24aa 0%, #ab47bc 100%);
            flex: 1;
            min-width: 0;
        }

        .btn-config {
            background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
            flex: 1;
            min-width: 0;
        }

        /* Bot√≥n Smart Sync (Nuevo) */
        .btn-smart-sync {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            width: clamp(36px, 9vw, 40px);
            height: clamp(36px, 9vw, 40px);
            border-radius: 50%;
            padding: 8px;
            gap: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: none;
            min-height: unset;
            position: relative;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            border: none;
            cursor: pointer;
            z-index: 5;
        }

        .btn-smart-sync:hover {
            transform: scale(1.05);
            /* Solo un ligero zoom, sin rotaci√≥n ni sombra extra */
        }

        .btn-smart-sync:active {
            transform: scale(0.95);
        }

        .btn-smart-sync.has-update::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background-color: #dc3545;
            /* Rojo est√°ndar sin brillo */
            border-radius: 50%;
            border: 2px solid white;
            /* Animation pulse removed */
        }

        .btn-help {
            background: linear-gradient(135deg, #ff9800 0%, #ffca28 100%);
            width: clamp(36px, 9vw, 40px);
            height: clamp(36px, 9vw, 40px);
            border-radius: 50%;
            font-size: clamp(18px, 5vw, 20px);
            padding: 0;
            gap: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: none;
            color: #222;
            font-weight: bold;
            min-height: unset;
        }

        .btn-edit {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            width: clamp(32px, 8vw, 36px);
            height: clamp(32px, 8vw, 36px);
            border-radius: 50%;
            font-size: clamp(14px, 3.5vw, 16px);
            padding: 0;
            gap: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: none;
            color: white;
            font-weight: bold;
            min-height: unset;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        .btn-edit:active {
            transform: scale(0.95);
        }

        .btn-edit-mode {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            width: clamp(36px, 9vw, 40px);
            height: clamp(36px, 9vw, 40px);
            border-radius: 50%;
            font-size: clamp(16px, 4vw, 18px);
            padding: 0;
            gap: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: none;
            color: white;
            font-weight: bold;
            min-height: unset;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        .btn-edit-mode.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
        }

        .btn-undo {
            background: linear-gradient(135deg, #fd7e14 0%, #e55d00 100%);
            padding: clamp(6px, 1.5vw, 8px) clamp(8px, 2vw, 10px);
            border-radius: clamp(6px, 1.5vw, 8px);
            color: white;
            font-weight: 600;
            font-size: clamp(11px, 2.8vw, 13px);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
        }

        .btn-undo:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(253, 126, 20, 0.3);
        }

        .btn-undo:active {
            transform: scale(0.95);
        }

        .btn-undo:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }

        /* Secciones (modales) */
        .section {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .section.active {
            display: flex;
        }

        .section-content {
            background: white;
            border-radius: 16px;
            padding: clamp(20px, 5vw, 30px);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .section-content h2 {
            font-size: clamp(18px, 4vw, 22px);
            margin-bottom: 15px;
            color: #1a8c42;
            text-align: center;
        }

        .section-content p {
            margin-bottom: 10px;
            font-size: clamp(12px, 3vw, 14px);
        }

        .section-content textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            margin-bottom: 15px;
            resize: vertical;
        }

        .section-content input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            margin: 8px 0 15px 0;
        }

        .section-content label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: clamp(12px, 3vw, 14px);
        }

        .section-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .section-buttons .btn {
            flex: 1;
            min-width: 120px;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);
        }

        .btn-cancel {
            background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
        }

        /* Status mensajes */
        #status {
            display: none;
            padding: clamp(10px, 2.5vw, 12px);
            border-radius: clamp(8px, 2vw, 10px);
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
            font-size: clamp(12px, 3vw, 14px);
            animation: slideIn 0.3s ease-out;
        }

        #status.success {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
            display: block;
        }

        #status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
            display: block;
        }

        #status.processing {
            background-color: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Leyenda */
        .legend {
            display: flex;
            justify-content: center;
            gap: clamp(10px, 3vw, 15px);
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: clamp(10px, 2.5vw, 12px);
            color: #555;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-color.green {
            background: #d4edda;
        }

        .legend-color.yellow {
            background: #fff3cd;
        }

        .legend-color.red {
            background: #f8d7da;
        }

        /* Tabla estilo Excel */
        .data-table {
            background-color: white;
            border-radius: clamp(10px, 2.5vw, 14px);
            /* overflow-x: auto; - Removed to allow sticky header */
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(0, 0, 0, 0.05);
            width: calc(100% - 2mm);
            margin: 0 1mm;
            -webkit-overflow-scrolling: touch;
        }

        /* Sin m√°rgenes en m√≥vil */
        @media screen and (max-width: 768px) {
            .data-table {
                margin: 0;
                width: 100%;
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: clamp(8px, 2vw, 10px);
        }

        .table-header {
            background: linear-gradient(135deg, #8A2BE2 0%, #9932CC 100%);
            /* Purple gradient */
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(138, 43, 226, 0.25);
            /* Adjusted shadow for purple */
        }

        thead th {
            padding: clamp(8px, 2vw, 10px) clamp(3px, 1vw, 5px);
            text-align: center;
            font-weight: 700;
            text-transform: uppercase;
            font-size: clamp(7px, 1.8vw, 9px);
            border-right: 1px solid rgba(255, 255, 255, 0.5);
            white-space: nowrap;
            line-height: 1.2;
        }

        thead th:last-child {
            border-right: none;
        }

        tbody tr {
            border-bottom: 1.5px solid black;
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f5f5f5;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        tbody td {
            padding: clamp(6px, 1.5vw, 8px) clamp(3px, 1vw, 5px);
            text-align: center;
            border-right: 1px solid black;
            font-size: clamp(9px, 2.2vw, 11px);
            word-break: break-word;
        }

        tbody td:last-child {
            border-right: none;
        }

        tbody td:first-child {
            font-weight: 600;
            text-align: left;
            padding-left: clamp(4px, 1.5vw, 8px);
        }

        tfoot td {
            padding: clamp(8px, 2vw, 10px) clamp(3px, 1vw, 5px);
            text-align: center;
            font-weight: 700;
            background: #f8f9fa;
            border-top: 2px solid #0d47a1;
            border-right: 1px solid #e0e0e0;
            font-size: clamp(9px, 2.2vw, 11px);
        }

        tfoot td:last-child {
            border-right: none;
        }

        /* Colores por rendimiento */
        .green {
            background-color: #d4edda !important;
            color: #155724;
        }

        .yellow {
            background-color: #fff3cd !important;
            color: #856404;
        }

        .red {
            background-color: #f8d7da !important;
            color: #721c24;
        }

        /* VISTA PREVIA DE CAMBIOS - Solo para admin */
        .preview-row {
            background-color: #e3f2fd !important;
            /* Azul muy claro */
            font-size: clamp(7px, 1.8vw, 9px) !important;
            opacity: 0.9;
        }

        .preview-row td {
            padding: clamp(3px, 1vw, 5px) clamp(2px, 0.8vw, 4px) !important;
            border-right: 1px dashed #90caf9 !important;
            border-top: 1px dashed #90caf9 !important;
            border-bottom: 2px dashed #2196f3 !important;
            color: #1565c0 !important;
            font-style: italic;
        }

        .preview-row td:first-child {
            border-left: 3px solid #2196f3 !important;
            font-weight: 600;
        }

        .preview-row td:last-child {
            border-right: 3px solid #2196f3 !important;
        }

        .preview-label {
            display: inline-block;
            background: #2196f3;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: clamp(6px, 1.5vw, 8px);
            margin-right: 3px;
            font-weight: 600;
        }

        .preview-section-title {
            text-align: center;
            color: #1565c0;
            font-size: clamp(10px, 2.5vw, 12px);
            margin: 8px 0;
            font-weight: 600;
            background: #e3f2fd;
            padding: 4px;
            border-radius: 4px;
            border-left: 3px solid #2196f3;
        }

        /* Estilos para indicadores de vista previa */
        .preview-row-new {
            background-color: #d4edda !important;
            font-size: clamp(7px, 1.8vw, 9px) !important;
            opacity: 0.9;
        }

        .preview-row-new td {
            padding: clamp(3px, 1vw, 5px) clamp(2px, 0.8vw, 4px) !important;
            border-right: 1px dashed #28a745 !important;
            border-top: 1px dashed #28a745 !important;
            border-bottom: 2px dashed #28a745 !important;
            color: #155724 !important;
            font-style: italic;
        }

        .preview-row-new td:first-child {
            border-left: 3px solid #28a745 !important;
            font-weight: 600;
        }

        .preview-row-new td:last-child {
            border-right: 3px solid #28a745 !important;
        }

        .preview-row-banned {
            background-color: #f8d7da !important;
            font-size: clamp(7px, 1.8vw, 9px) !important;
            opacity: 0.7;
        }

        .preview-row-banned td {
            padding: clamp(3px, 1vw, 5px) clamp(2px, 0.8vw, 4px) !important;
            border-right: 1px dashed #dc3545 !important;
            border-top: 1px dashed #dc3545 !important;
            border-bottom: 2px dashed #dc3545 !important;
            color: #721c24 !important;
            font-style: italic;
            text-decoration: line-through;
        }

        .preview-row-banned td:first-child {
            border-left: 3px solid #dc3545 !important;
            font-weight: 600;
        }

        .preview-row-banned td:last-child {
            border-right: 3px solid #dc3545 !important;
        }

        .preview-label-new {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: clamp(6px, 1.5vw, 8px);
            margin-right: 3px;
            font-weight: 600;
        }

        .preview-label-banned {
            display: inline-block;
            background: #dc3545;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: clamp(6px, 1.5vw, 8px);
            margin-right: 3px;
            font-weight: 600;
        }

        .absent-player td {
            background: #f1f3f5 !important;
            color: #adb5bd !important;
            font-style: italic;
        }

        /* Estilo para la fila seleccionada */
        .selected-row td {
            border: 4px solid #8A2BE2 !important;
            /* Borde morado para resaltar */
            /* No cambiar color de fondo ni de texto */
        }

        .selected-row td:first-child {
            border-left: 4px solid #8A2BE2 !important;
        }

        .selected-row td:last-child {
            border-right: 4px solid #8A2BE2 !important;
        }

        .selected-row+tr td {
            border-top: 0 !important;
            /* Evitar doble borde entre filas seleccionadas */
        }

        .selected-row td:not(:first-child) {
            border-left: 0 !important;
            /* Para que parezca un borde continuo */
        }

        .selected-row td:not(:last-child) {
            border-right: 0 !important;
        }

        .selected-row td span {
            /* Revertir cambios de color de texto */
            color: inherit !important;
            text-shadow: inherit !important;
        }

        /* Medallas de ranking */
        .rank-medal {
            display: inline-block;
            margin-left: 4px;
            font-size: clamp(12px, 3vw, 14px);
        }

        /* Footer de info */
        .footer-info {
            text-align: center;
            color: #6c757d;
            font-size: clamp(10px, 2.5vw, 12px);
            margin-top: 15px;
            padding: 10px;
        }

        .footer-info p {
            margin: 5px 0;
        }

        .btn-backup {
            background: transparent;
            color: #6c757d;
            border: 1px solid #dee2e6;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .btn-backup:hover {
            background: #f8f9fa;
            color: #495057;
            border-color: #adb5bd;
        }

        .btn-check-similarity {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            flex: 1;
            min-width: 120px;
        }

        .btn-save {
            background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);
            width: clamp(36px, 9vw, 40px);
            height: clamp(36px, 9vw, 40px);
            border-radius: 50%;
            font-size: clamp(18px, 5vw, 20px);
            padding: 0;
            gap: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: none;
            color: white;
            font-weight: bold;
            min-height: unset;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        .btn-sync {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            width: clamp(36px, 9vw, 40px);
            height: clamp(36px, 9vw, 40px);
            border-radius: 50%;
            font-size: clamp(16px, 4vw, 18px);
            padding: 0;
            gap: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: none;
            color: white;
            font-weight: bold;
            min-height: unset;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        .btn-sync:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
        }

        .btn-sync:active {
            transform: scale(0.95);
        }

        .btn-sync:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }

        .unsaved-indicator {
            display: none;
            color: #ff9800;
            font-size: clamp(11px, 2.8vw, 13px);
            font-weight: bold;
            text-align: center;
            margin-top: 8px;
            animation: pulse 2s infinite;
        }

        .unsaved-indicator.show {
            display: block;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        /* Panel de revisi√≥n de similitud */
        .review-content {
            background: white;
            border-radius: 16px;
            padding: 15px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .review-content h2 {
            font-size: clamp(16px, 3.5vw, 20px);
            margin-bottom: 8px;
            color: #1a8c42;
            text-align: center;
        }

        .review-content p {
            text-align: center;
            color: #666;
            margin-bottom: 10px;
            font-size: clamp(11px, 2.8vw, 13px);
        }

        .review-items-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .review-item {
            background: white;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #dee2e6;
            transition: all 0.2s;
            min-height: 50px;
        }

        .review-item:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.1);
        }

        .review-item.matched {
            border-left: 4px solid #ffc107;
            background: #fffdf5;
        }

        .review-item.identical {
            border-left: 4px solid #007bff;
            background: #e7f3ff;
        }

        .review-item.new {
            border-left: 4px solid #28a745;
            background: #f0fff4;
        }

        .review-item.selected {
            border-color: #28a745;
            background: #d4edda;
        }

        .review-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0;
            flex-wrap: nowrap;
        }

        .review-name-section {
            flex: 0 0 auto;
            min-width: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 2px;
        }

        .review-name-section .review-similarity,
        .review-name-section .review-donation {
            font-size: clamp(9px, 2.2vw, 11px);
            padding: 1px 4px;
        }

        .review-label {
            font-size: clamp(8px, 2vw, 10px);
            color: #666;
            margin-bottom: 1px;
            font-weight: 600;
        }

        .review-name {
            font-size: clamp(12px, 3vw, 14px);
            font-weight: 700;
            color: #333;
            padding: 4px 6px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .review-name-input {
            font-size: clamp(11px, 2.8vw, 13px);
            font-weight: 700;
            color: #333;
            padding: 3px 5px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            width: 100px;
            height: 26px;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            flex-shrink: 0;
        }

        .review-name-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        .review-actions {
            display: flex;
            gap: 6px;
            flex-wrap: nowrap;
            align-items: center;
        }

        .review-donation {
            font-size: clamp(10px, 2.5vw, 12px);
            color: #666;
            padding: 3px 6px;
            background: #fff3cd;
            border-radius: 4px;
            border: 1px solid #ffeeba;
            font-weight: 600;
            white-space: nowrap;
        }

        .review-similarity {
            font-size: clamp(10px, 2.5vw, 12px);
            color: #666;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            white-space: nowrap;
        }

        .similarity-high {
            background: #d1ecf1;
            color: #0056b3;
        }

        .similarity-medium {
            background: #fff3cd;
            color: #856404;
        }

        .similarity-perfect {
            background: #007bff;
            color: white;
        }

        .btn-assign {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: clamp(10px, 2.5vw, 12px);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn-assign:not([disabled]) {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }

        .btn-create-new:not([disabled]) {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }

        .btn-assign:hover {
            transform: scale(1.02);
            box-shadow: 0 1px 4px rgba(0, 123, 255, 0.2);
        }

        .btn-assign:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }

        .btn-create-new {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: clamp(10px, 2.5vw, 12px);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn-create-new:hover {
            transform: scale(1.02);
            box-shadow: 0 1px 4px rgba(40, 167, 69, 0.2);
        }

        .btn-create-new:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }

        .review-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Responsive para m√≥viles */
        @media screen and (max-width:768px) {
            .review-row {
                flex-direction: column;
            }

            .review-name-section {
                min-width: 100%;
                margin-bottom: 10px;
            }

            .review-actions {
                width: 100%;
                justify-content: center;
            }
        }

        /* Modal de ayuda */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: clamp(20px, 5vw, 30px);
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #888;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-content h2 {
            color: #1a8c42;
            margin-bottom: 15px;
            font-size: clamp(18px, 4vw, 22px);
        }

        .modal-content ul {
            list-style-position: inside;
            padding-left: 0;
        }

        .modal-content li {
            margin-bottom: 10px;
            font-size: clamp(12px, 3vw, 14px);
            line-height: 1.5;
        }

        /* Responsividad para pantallas muy peque√±as */
        @media screen and (max-width: 360px) {

            .btn-manual span,
            .btn-config span {
                display: none;
            }

            .btn-manual::after {
                content: '‚å®Ô∏è';
                font-size: 18px;
            }

            .btn-config::after {
                content: '‚öôÔ∏è';
                font-size: 18px;
            }
        }

        /* Asegurar que nada se salga del viewport */
        * {
            max-width: 100%;
        }

        /* Bot√≥n de configuraci√≥n */
        .btn-settings {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            width: clamp(36px, 9vw, 40px);
            height: clamp(36px, 9vw, 40px);
            border-radius: 50%;
            font-size: clamp(16px, 4vw, 18px);
            padding: 0;
            gap: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: none;
            color: white;
            font-weight: bold;
            min-height: unset;
        }

        /* Items de configuraci√≥n */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #ddd;
            font-size: clamp(14px, 3.5vw, 16px);
            font-weight: 600;
        }

        .setting-item input[type="checkbox"] {
            transform: scale(1.5);
            margin-left: 10px;
            cursor: pointer;
            width: 24px;
            height: 24px;
        }

        .setting-description {
            font-size: clamp(11px, 2.8vw, 13px);
            font-weight: 400;
            color: #666;
            margin-top: 4px;
        }

        /* Bot√≥n de instalaci√≥n */
        .btn-install {
            width: 100%;
            margin-top: 15px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            padding: 12px 20px;
            font-size: clamp(13px, 3.3vw, 15px);
        }

        .btn-install:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header principal -->
        <div class="header">
            <h1>üêú Donaciones Invencibles</h1>
            <div class="header-subtitle" id="headerLastUpdate">
                √öltima actualizaci√≥n: Cargando...
            </div>
            <div class="version-tag">v3.7</div>
        </div>

        <!-- Botones de acci√≥n -->
        <div class="action-buttons">
            <button class="btn btn-manual" onclick="showManual()" title="Ingresar donaciones manualmente">
                <span>‚å®Ô∏è Entrada Manual</span>
            </button>
            <button id="smartSyncBtn" class="btn btn-smart-sync" onclick="smartSyncAction()"
                title="Sincronizaci√≥n Inteligente">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                    style="width: 100%; height: 100%;">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3" />
                </svg>
            </button>
            <button class="btn btn-help" onclick="showInfo()" title="Ver gu√≠a de usuario">?</button>
            <button class="btn-save" id="saveBtn" onclick="manualSave()"
                title="Opciones de guardado y cierre de semana">‚úì</button>

            <button class="btn btn-edit-mode" id="editModeBtn" onclick="toggleEditMode()" style="display:none;"
                title="Modo Edici√≥n">üìù</button>
            <button class="btn btn-settings" onclick="showSettings()" title="Ajustes de la aplicaci√≥n">‚öôÔ∏è</button>
            <button class="btn btn-config" onclick="configGoal()" title="Cambiar la meta diaria">
                <span>‚öôÔ∏è Configurar Meta</span>
            </button>
        </div>

        <!-- Indicador de cambios sin guardar -->
        <div class="unsaved-indicator" id="unsavedIndicator">‚ö†Ô∏è Hay cambios sin guardar en Firebase</div>

        <!-- Status mensajes -->
        <div id="status"></div>

        <!-- Tabla de datos -->
        <div class="data-table">
            <table id="table">
                <thead class="table-header" id="tableHeader">
                    <tr>
                        <th>NOMBRE</th>
                        <th>TEN√çA</th>
                        <th>TIENE</th>
                        <th>SEMANAL</th>
                        <th>√ò DIARIO</th>
                        <th>%META</th>
                        <th>ACUMULADO</th>
                        <th>TOTAL</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
                <tfoot></tfoot>
            </table>
        </div>

        <!-- Footer info -->
        <!-- Footer info -->
        <div class="footer-info">
            <p>üì± v3.7.0 | √öltima actualizaci√≥n: <span id="lastUpdateTime">-</span></p>
            <p>üóìÔ∏è Semana iniciada: <span id="weekStartTime">-</span></p>
            <p id="admin-login-container" style="margin-top: 10px;"></p>
            <div id="backupButtons" style="display: none; margin-top: 10px;">
                <button class="btn-backup" id="backupBtn" onclick="backupData()">üíæ Copia de Seguridad</button>
                <button class="btn-backup" id="restoreBtn" onclick="document.getElementById('restoreFile').click()">üìÇ
                    Restaurar Copia</button>
                <input type="file" id="restoreFile" accept=".txt,.json" style="display: none;"
                    onchange="restoreBackup(event)">
            </div>
        </div>
    </div>
    </div>
    </div>

    <!-- Secci√≥n de entrada manual -->
    <div id="manualSection" class="section">
        <div class="section-content">
            <h2>üìù Entrada Manual de Datos</h2>
            <p><strong>Formato:</strong> nombre,donaci√≥n (una por l√≠nea)</p>
            <p><strong>Ejemplo:</strong><br>Juan,25000<br>Mar√≠a,18500</p>
            <textarea id="manualInput" placeholder="Ingresa los datos aqu√≠..."
                oninput="updateManualPreview()"></textarea>
            <div class="section-buttons">
                <button class="btn btn-success" onclick="processManual()">‚úÖ Revisar Datos</button>
                <button class="btn btn-check-similarity" onclick="checkSimilarity()">üîç Verificar Similitud</button>
                <button class="btn btn-cancel" onclick="hideManual()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Secci√≥n de configuraci√≥n -->
    <div id="configSection" class="section">
        <div class="section-content">
            <h2>‚öôÔ∏è Configuraci√≥n de Meta</h2>
            <label for="newGoal"><strong>Meta diaria por jugador:</strong></label>
            <input type="number" id="newGoal" value="15000" min="1000" max="100000" step="1000">
            <div class="section-buttons">
                <button class="btn btn-success" onclick="saveGoal()">üíæ Guardar Meta</button>
                <button class="btn btn-cancel" onclick="hideConfig()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Secci√≥n de revisi√≥n de similitud -->
    <div id="reviewSection" class="section">
        <div class="review-content">
            <h2>üîç Revisar Similitud de Nombres</h2>
            <p>Verifica los nombres nuevos y asigna a usuarios existentes si hay similitud.</p>

            <div id="reviewItemsList" class="review-items-list"></div>

            <div id="reviewSummary" class="review-summary"></div>

            <div class="review-buttons" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <button class="btn btn-success" onclick="confirmNameMapping()">
                    ‚úÖ Importar a Tabla (Local)
                </button>
                <button class="btn btn-cancel" onclick="hideReview()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de ayuda -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="hideInfo()">&times;</span>
            <h2>üìñ Gu√≠a de Usuario</h2>

            <h3 style="color: #1a8c42; margin-top: 10px; border-bottom: 2px solid #e0e0e0; padding-bottom: 5px;">üìä
                Columnas de la Tabla</h3>
            <ul style="font-size: 13px; line-height: 1.6;">
                <li><strong>NOMBRE:</strong> Nombre del jugador. Los Top 5 reciben medallas (ü•áü•àü•â...).</li>
                <li><strong>TEN√çA:</strong> Donaci√≥n total registrada antes de la semana actual.</li>
                <li><strong>TIENE:</strong> Donaci√≥n total actual (seg√∫n el juego).</li>
                <li><strong>SEMANAL:</strong> Lo donado esta semana (Tiene - Ten√≠a).</li>
                <li><strong>√ò DIARIO:</strong> Promedio de donaci√≥n por d√≠a (Semanal / 7).</li>
                <li><strong>%META:</strong> Porcentaje de cumplimiento de la meta semanal.</li>
                <li><strong>ACUMULADO:</strong> Exceso de donaciones guardado ("Mochila"). Se usa autom√°ticamente para
                    cubrir faltas.</li>
                <li><strong>TOTAL:</strong> Suma hist√≥rica total de donaciones.</li>
            </ul>



            <h3 style="color: #1a8c42; margin-top: 15px; border-bottom: 2px solid #e0e0e0; padding-bottom: 5px;">üé®
                Leyenda de Colores</h3>
            <div class="legend" style="justify-content: flex-start; gap: 10px;">
                <div class="legend-item">
                    <div class="legend-color green"></div> >90% Meta
                </div>
                <div class="legend-item">
                    <div class="legend-color yellow"></div> 70-89% Meta
                </div>
                <div class="legend-item">
                    <div class="legend-color red"></div>
                    <70% Meta</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secci√≥n de Login -->
    <div id="loginSection" class="section">
        <div class="section-content">
            <h2>üîê Iniciar Sesi√≥n de Administrador</h2>
            <label for="loginEmail"><strong>Correo electr√≥nico:</strong></label>
            <input type="email" id="loginEmail" placeholder="correo@ejemplo.com">
            <label for="loginPass"><strong>Contrase√±a:</strong></label>
            <input type="password" id="loginPass" placeholder="Ingresa la contrase√±a">
            <div class="section-buttons">
                <button class="btn btn-success" onclick="login()">‚úÖ Iniciar Sesi√≥n</button>
                <button class="btn btn-cancel" onclick="hideLogin()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de configuraci√≥n -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="hideSettings()">&times;</span>
            <h2>‚öôÔ∏è Configuraci√≥n</h2>

            <div class="setting-item">
                <div>
                    <div>üîî Notificaciones</div>
                    <div class="setting-description">Recibe avisos cuando hay cambios de datos</div>
                </div>
                <input type="checkbox" id="notifToggle" onchange="toggleNotifications()">
            </div>

            <button class="btn btn-install" id="installBtn" onclick="installApp()" style="display:none;">
                üì± Instalar App
            </button>



            <div class="section-buttons" style="margin-top: 20px;">
                <button class="btn btn-cancel" onclick="hideSettings()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de opciones de guardado -->
    <div id="saveOptionsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="hideSaveOptions()">&times;</span>
            <h2>üíæ Opciones de Guardado</h2>
            <p>Elige qu√© acci√≥n deseas realizar:</p>

            <button class="btn btn-success" onclick="executeSave('UPDATE')"
                style="width: 100%; margin-bottom: 15px; padding: 15px; height: auto; white-space: normal; display: flex; flex-direction: column; align-items: flex-start; text-align: left;">
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">‚úÖ Guardar Cambios</div>
                <div style="font-size: 12px; font-weight: normal; opacity: 0.9;">Actualiza los datos locales y en
                    Firebase. La semana contin√∫a normalmente.</div>
            </button>

            <button class="btn btn-manual" onclick="executeSave('NEW_WEEK')"
                style="width: 100%; padding: 15px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); height: auto; white-space: normal; display: flex; flex-direction: column; align-items: flex-start; text-align: left;">
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">üîÑ Cerrar Semana e Iniciar Nueva
                </div>
                <div style="font-size: 12px; font-weight: normal; opacity: 0.9;">Calcula acumulados finales, reinicia
                    contadores a cero y guarda todo en Firebase.</div>
            </button>

            <div class="section-buttons" style="margin-top: 20px;">
                <button class="btn btn-cancel" onclick="hideSaveOptions()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de opciones de Sincronizaci√≥n (Smart Sync) -->
    <div id="syncOptionsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="hideSyncOptions()">&times;</span>
            <h2 style="color: #007bff;">‚òÅÔ∏è Sincronizaci√≥n</h2>
            <p>Estado y herramientas de reparaci√≥n:</p>

            <!-- Bot√≥n de Actualizar App (Solo visible si hay update) -->
            <button id="btnUpdateApp" class="btn" onclick="executeSync('UPDATE_APP')"
                style="display: none; width: 100%; margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; height: auto; white-space: normal; flex-direction: column; align-items: flex-start; text-align: left;">
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">üöÄ Actualizar Aplicaci√≥n</div>
                <div style="font-size: 12px; font-weight: normal; opacity: 0.9;">Nueva versi√≥n disponible. Clic para
                    instalar.</div>
            </button>

            <!-- Bot√≥n de Sincronizar Datos -->
            <button class="btn" onclick="executeSync('SYNC_DATA')"
                style="width: 100%; margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; height: auto; white-space: normal; display: flex; flex-direction: column; align-items: flex-start; text-align: left;">
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">‚òÅÔ∏è Sincronizar Datos</div>
                <div style="font-size: 12px; font-weight: normal; opacity: 0.9;">Descargar los √∫ltimos datos desde la
                    nube.</div>
            </button>

            <!-- Bot√≥n de Reparar -->
            <button class="btn" onclick="executeSync('REPAIR')"
                style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; height: auto; white-space: normal; display: flex; flex-direction: column; align-items: flex-start; text-align: left;">
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">üõ†Ô∏è Reparar / Recargar</div>
                <div style="font-size: 12px; font-weight: normal; opacity: 0.9;">¬øProblemas? Limpia la memoria y recarga
                    la App.</div>
            </button>

            <div class="section-buttons" style="margin-top: 20px;">
                <button class="btn btn-cancel" onclick="hideSyncOptions()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // --- INICIO DE LA INTEGRACI√ìN CON FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBey3djeWd5dvhRWpt_RZcqVq3BtwugdIw",
            authDomain: "donacionespwav2.firebaseapp.com",
            projectId: "donacionespwav2",
            storageBucket: "donacionespwav2.firebasestorage.app",
            messagingSenderId: "854523614232",
            appId: "1:854523614232:web:0b537fa35a0d9f47ef9f6d",
            measurementId: "G-5N0MWZT1QC"
        };

        // Configuraci√≥n global
        const CONFIG = {
            DEFAULT_GOAL: 15000
        };

        // Variables globales
        let players = {};
        let goalDaily = CONFIG.DEFAULT_GOAL;
        let lastUpdate = Date.now();
        let weekStart = getWeekStart();
        let auth;
        let firestoreDB;

        // Nuevas variables para PWA
        let db;
        let notificationsEnabled = false;
        let deferredPrompt = null;
        let lastDataTimestamp = null;
        let indexedDBInitialized = false;

        // Variable para vista previa de cambios
        let previewData = null; // Almacena los datos calculados para preview

        const DB_NAME = 'DonacionesDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'data';

        // --- FUNCIONES DE INDEXEDDB (OFFLINE) ---

        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error('Error al abrir IndexedDB:', event.target.error);
                    reject(event.target.error);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('IndexedDB inicializado correctamente');
                    indexedDBInitialized = true;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                    console.log('IndexedDB actualizado a versi√≥n', DB_VERSION);
                };
            });
        }

        async function saveToLocal(data) {
            if (!db) return;

            try {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);

                const record = {
                    id: 'main',
                    timestamp: Date.now(),
                    players: data.players,
                    goalDaily: data.goalDaily,
                    lastUpdate: data.lastUpdate,
                    weekStart: data.weekStart
                };

                objectStore.put(record);

                return new Promise((resolve, reject) => {
                    transaction.oncomplete = () => {
                        console.log('Datos guardados en IndexedDB');
                        resolve();
                    };
                    transaction.onerror = () => {
                        console.error('Error al guardar en IndexedDB');
                        reject();
                    };
                });
            } catch (error) {
                console.error('Error en saveToLocal:', error);
            }
        }

        async function loadFromLocal() {
            if (!db) return null;

            try {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.get('main');

                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        const result = request.result;
                        if (result) {
                            console.log('Datos cargados desde IndexedDB');
                            lastDataTimestamp = result.timestamp;
                        }
                        resolve(result);
                    };
                    request.onerror = () => {
                        console.error('Error al cargar desde IndexedDB');
                        reject();
                    };
                });
            } catch (error) {
                console.error('Error en loadFromLocal:', error);
                return null;
            }
        }

        function notifyNewData() {
            if (!notificationsEnabled || Notification.permission !== 'granted') return;

            const playerCount = Object.keys(players).length;
            new Notification('üìä Datos actualizados', {
                body: `${playerCount} jugadores con nuevas donaciones`,
                icon: 'icon-192x192.png',
                badge: 'icon-192x192.png',
                tag: 'data-update',
                renotify: true
            });
        }

        // --- FUNCIONES DE CONFIGURACI√ìN ---

        function toggleNotifications() {
            const toggle = document.getElementById('notifToggle');

            if (toggle.checked) {
                if (!('Notification' in window)) {
                    showStatus('‚ùå Tu navegador no soporta notificaciones', 'error');
                    toggle.checked = false;
                    return;
                }

                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notificationsEnabled = true;
                        localStorage.setItem('notificationsEnabled', true);
                        showStatus('‚úÖ Notificaciones activadas', 'success');

                        new Notification('Donaciones Invencibles', {
                            body: '¬°Notificaciones activadas correctamente!',
                            icon: 'icon-192x192.png'
                        });
                    } else {
                        toggle.checked = false;
                        showStatus('‚ùå Permisos de notificaci√≥n denegados', 'error');
                    }
                });
            } else {
                notificationsEnabled = false;
                localStorage.setItem('notificationsEnabled', false);
                showStatus('üîï Notificaciones desactivadas', 'success');
            }
        }

        function loadNotificationPreference() {
            notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
            const toggle = document.getElementById('notifToggle');
            if (toggle) toggle.checked = notificationsEnabled;
        }



        function showSettings() {
            hideAllSections();
            document.getElementById('settingsModal').classList.add('active');
        }

        function hideSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }



        function installApp() {
            if (!deferredPrompt) {
                showStatus('‚ùå No se puede instalar la app en este momento', 'error');
                return;
            }

            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('Usuario acept√≥ la instalaci√≥n');
                    document.getElementById('installBtn').style.display = 'none';
                    showStatus('‚úÖ App instalada correctamente', 'success');
                } else {
                    console.log('Usuario rechaz√≥ la instalaci√≥n');
                }
                deferredPrompt = null;
            });
        }



        // --- INICIALIZACI√ìN Y AUTENTICACI√ìN ---

        document.addEventListener('DOMContentLoaded', function () {
            try {
                // Inicializar Firebase y los servicios
                const app = firebase.initializeApp(firebaseConfig);
                firestoreDB = firebase.firestore();
                auth = firebase.auth();

                // ESCAPE HATCH: Borrado de cach√© forzado por URL
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('force_reset')) {
                    console.log('üõë Force Reset detected from URL');
                    showStatus('‚ö†Ô∏è Ejecutando reparaci√≥n de emergencia...', 'warning');
                    // Limpiar URL para no entrar en bucle infinito tras recargar
                    window.history.replaceState({}, document.title, window.location.pathname);
                    setTimeout(() => forceClearCache(), 1000);
                    return; // Detener inicializaci√≥n normal
                }

                initAuth();
                initDB();
                updateEditModeButton();
                updateAdminButtons();
            } catch (error) {
                console.error("Error inicializando Firebase:", error);
                showStatus('Error cr√≠tico al iniciar la app.', 'error');
            }

            // Guardar los textos del encabezado una sola vez
            const headerTexts = Array.from(document.querySelectorAll('#table thead th')).map(th => th.innerHTML);

            // Listener para la selecci√≥n de filas de la tabla
            const tableBody = document.querySelector('#table tbody');
            if (tableBody) {
                tableBody.addEventListener('click', function (e) {
                    const targetRow = e.target.closest('tr');

                    // Asegurarse de que el clic fue en una fila de datos v√°lida
                    if (!targetRow || !tableBody.contains(targetRow) || targetRow.classList.contains('injected-header')) return;

                    const isAlreadySelected = targetRow.classList.contains('selected-row');

                    // Siempre remover el encabezado inyectado y la selecci√≥n anterior primero
                    const existingInjectedHeader = tableBody.querySelector('.injected-header');
                    if (existingInjectedHeader) {
                        existingInjectedHeader.remove();
                    }
                    const allRows = tableBody.querySelectorAll('tr');
                    allRows.forEach(row => {
                        row.classList.remove('selected-row');
                    });

                    // Si la fila no estaba ya seleccionada, seleccionarla ahora e inyectar el header si es necesario
                    if (!isAlreadySelected) {
                        targetRow.classList.add('selected-row');

                        // No inyectar el header para la primera fila de datos
                        const isFirstRow = tableBody.querySelector('tr:not(.injected-header)') === targetRow;

                        if (!isFirstRow) {
                            const newHeaderRow = document.createElement('tr');
                            newHeaderRow.classList.add('injected-header', 'table-header');
                            newHeaderRow.style.position = 'static'; // Evitar comportamiento 'sticky' no deseado
                            newHeaderRow.innerHTML = headerTexts.map(text => `<th>${text}</th>`).join('');
                            targetRow.parentNode.insertBefore(newHeaderRow, targetRow);
                        }
                    }
                });
            }
        });

        async function initAuth() {
            try {
                // Usamos persistencia local para mantener al usuario logueado
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

                auth.onAuthStateChanged(user => {
                    updateUIAfterAuthStateChange(user);
                });
            } catch (error) {
                showStatus('Error de autenticaci√≥n: ' + error.message, 'error');
                console.error('Auth Init Error:', error);
            }
        }

        function updateUIAfterAuthStateChange(user) {
            const adminLoginContainer = document.getElementById('admin-login-container');
            if (!adminLoginContainer) return;

            if (user) {
                // Usuario logueado
                adminLoginContainer.innerHTML = `<a href="#" onclick="logout(); return false;" style="color: #6c757d; text-decoration: none;">Cerrar Sesi√≥n (Admin)</a>`;
            } else {
                // Usuario no logueado
                adminLoginContainer.innerHTML = `<a href="#" onclick="showLogin(); return false;" style="color: #6c757d; text-decoration: none;">Login Admin</a>`;
                hideAllSections();
            }

            updateEditModeButton();
            updateAdminButtons();
        }

        function updateAdminButtons() {
            const saveBtn = document.getElementById('saveBtn');
            const backupButtons = document.getElementById('backupButtons');

            if (auth.currentUser) {
                // Admin - Mostrar botones
                if (saveBtn) saveBtn.style.display = 'flex';
                if (backupButtons) backupButtons.style.display = 'block';
            } else {
                // No admin - Ocultar botones
                if (saveBtn) saveBtn.style.display = 'none';
                if (backupButtons) backupButtons.style.display = 'none';
            }
        }

        async function initDB() {
            try {
                await initIndexedDB();

                const localData = await loadFromLocal();

                if (localData) {
                    players = localData.players || {};
                    goalDaily = localData.goalDaily || CONFIG.DEFAULT_GOAL;
                    lastUpdate = localData.lastUpdate || Date.now();
                    weekStart = localData.weekStart || getWeekStart();
                    lastDataTimestamp = localData.timestamp;

                    console.log('Cargando datos desde IndexedDB');
                } else {
                    await loadData();
                }

                renderTable();
                updateTimeDisplays();
            } catch (error) {
                showStatus('Error al inicializar la base de datos: ' + error.message, 'error');
                console.error('DB Error:', error);
            }
        }

        // --- FUNCIONES DE AUTENTICACI√ìN ---

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPass').value;

            if (!email || !password) {
                showStatus('Por favor, ingresa email y contrase√±a.', 'error');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                hideLogin();
                showStatus('¬°Sesi√≥n iniciada correctamente!', 'success');
            } catch (error) {
                showStatus('Error al iniciar sesi√≥n: ' + error.message, 'error');
                console.error('Login Error:', error);
            }
        }

        async function logout() {
            try {
                await auth.signOut();
                showStatus('Sesi√≥n cerrada.', 'success');
            } catch (error) {
                showStatus('Error al cerrar sesi√≥n: ' + error.message, 'error');
                console.error('Logout Error:', error);
            }
        }

        // --- L√ìGICA DE DATOS (Firestore) ---

        async function loadData() {
            try {
                const docRef = firestoreDB.collection('data').doc('main');
                const doc = await docRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    players = data.players || {};
                    goalDaily = data.goalDaily || CONFIG.DEFAULT_GOAL;
                    lastUpdate = data.lastUpdate || Date.now();
                    weekStart = data.weekStart || getWeekStart();
                    lastSyncTime = lastUpdate;
                    updateSyncTimeDisplay();
                }
                renderTable();
                updateTimeDisplays();
            } catch (error) {
                showStatus('Error al cargar datos: ' + error.message, 'error');
                console.error('Load Error:', error);
            }
        }

        function getWeekStart() {
            const d = new Date();
            d.setHours(0, 0, 0, 0);
            const day = d.getDay();
            const monday = new Date(d);
            monday.setDate(d.getDate() - (day === 0 ? 6 : day - 1));
            return monday.getTime();
        }

        let lastSyncTime = null;

        async function forceSync() {
            try {
                const unsavedIndicator = document.getElementById('unsavedIndicator');
                const hasUnsavedChanges = unsavedIndicator && unsavedIndicator.classList.contains('show');

                if (hasUnsavedChanges) {
                    const confirmed = confirm(
                        '‚ö†Ô∏è Tienes cambios sin guardar en Firebase.\n\n' +
                        '¬øDeseas sincronizar de todas formas?\n\n' +
                        'Esto sobrescribir√° tus cambios locales con los datos del servidor.'
                    );

                    if (!confirmed) {
                        showStatus('‚ÑπÔ∏è Sincronizaci√≥n cancelada', 'success', 2000);
                        return;
                    }
                }

                showStatus('üîÑ Sincronizando datos...', 'processing');

                const docRef = firestoreDB.collection('data').doc('main');
                const doc = await docRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    const newDataTimestamp = data.lastUpdate || Date.now();

                    if (!lastSyncTime || newDataTimestamp > lastSyncTime) {
                        players = data.players || {};
                        goalDaily = data.goalDaily || CONFIG.DEFAULT_GOAL;
                        lastUpdate = data.lastUpdate || Date.now();
                        weekStart = data.weekStart || getWeekStart();
                        lastSyncTime = newDataTimestamp;

                        await saveToLocal({
                            players,
                            goalDaily,
                            lastUpdate,
                            weekStart,
                            timestamp: newDataTimestamp
                        });

                        renderTable();
                        updateTimeDisplays();
                        updateSyncTimeDisplay();
                        hideUnsavedIndicator();

                        console.log('Datos sincronizados forzadamente:', newDataTimestamp);
                        showStatus('‚úÖ Datos sincronizados correctamente', 'success', 3000);
                    } else {
                        updateSyncTimeDisplay();
                        showStatus('‚ÑπÔ∏è Los datos ya est√°n actualizados', 'success', 2000);
                    }
                } else {
                    showStatus('‚ö†Ô∏è No hay datos en Firebase', 'error', 3000);
                }
            } catch (error) {
                showStatus('Error al sincronizar: ' + error.message, 'error', 3000);
                console.error('Sync Error:', error);
            }
        }

        function updateSyncTimeDisplay() {
            const lastSyncElement = document.getElementById('lastSyncTime');
            if (!lastSyncElement) return;

            if (lastSyncTime) {
                const date = new Date(lastSyncTime);
                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                lastSyncElement.textContent = date.toLocaleDateString('es-ES', options);
            } else {
                lastSyncElement.textContent = 'Nunca';
            }
        }

        async function saveData() {
            try {
                const dataToSave = {
                    players,
                    goalDaily,
                    lastUpdate: Date.now(),
                    weekStart
                };

                await firestoreDB.collection('data').doc('main').set(dataToSave);
                await saveToLocal(dataToSave);

                lastUpdate = dataToSave.lastUpdate;
                lastDataTimestamp = lastUpdate;
                lastSyncTime = Date.now();
                updateTimeDisplays();
                updateSyncTimeDisplay();
                hideUnsavedIndicator();
            } catch (error) {
                showStatus('Error al guardar datos: ' + error.message, 'error');
                console.error('Save Error:', error);
            }
        }

        function showUnsavedIndicator() {
            const indicator = document.getElementById('unsavedIndicator');
            if (indicator) {
                indicator.classList.add('show');
            }
        }

        function hideUnsavedIndicator() {
            const indicator = document.getElementById('unsavedIndicator');
            if (indicator) {
                indicator.classList.remove('show');
            }
        }

        async function manualSave() {
            if (!auth.currentUser) {
                showStatus('‚ùå Debes iniciar sesi√≥n como admin.', 'error');
                return;
            }
            if (!confirm('¬øEst√°s seguro de que deseas guardar los cambios en Firebase? Esto actualizar√° los datos para todos los usuarios.')) {
                return;
            }
            await saveData();
            showStatus('‚úÖ Datos guardados en Firebase correctamente!', 'success');
        }

        // --- FUNCIONES DE RENDERIZADO Y FORMATO ---

        function formatNumber(num) {
            if (typeof num !== 'number' || isNaN(num)) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num.toLocaleString('es-ES');
        }

        function getColorClass(percentage, type) {
            if (type === 'percentage') {
                if (percentage >= 90) return 'green';
                if (percentage >= 70) return 'yellow';
                return 'red';
            }
            if (type === 'total') {
                if (percentage >= 100) return 'grad-green';
                return 'grad-red';
            }
            return '';
        }

        function calculatePercentages(player) {
            const semanal = (player.current || 0) - (player.previous || 0);
            const weeklyGoal = goalDaily * 7;
            const avgDaily = semanal / 7;
            const avgDailyPerc = (avgDaily / goalDaily) * 100;

            const availableExcess = Math.max(0, player.accumulatedExcess || 0);
            const weeklyDeficit = Math.max(0, weeklyGoal - semanal);
            const coveredWithAccumulated = Math.min(weeklyDeficit, availableExcess);
            const effectiveDonation = semanal + coveredWithAccumulated;
            const metaPerc = coveredWithAccumulated > 0
                ? Math.min(100, (effectiveDonation / weeklyGoal) * 100)
                : (semanal / weeklyGoal) * 100;

            const totalPerc = (player.total || 0) / weeklyGoal * 100;

            return {
                semanal: Math.max(0, semanal),
                avgDaily: Math.max(0, avgDaily),
                avgDailyPerc: Math.max(0, avgDailyPerc),
                metaPerc: Math.max(0, metaPerc),
                totalPerc: Math.max(0, totalPerc)
            };
        }

        function formatExtraDonationTime(totalDays) {
            if (totalDays < 1) return '';
            const daysPerWeek = 7, weeksPerMonth = 4, monthsPerYear = 12;
            const daysPerMonth = daysPerWeek * weeksPerMonth;
            const daysPerYear = daysPerMonth * monthsPerYear;
            let remainingDays = totalDays;
            const years = Math.floor(remainingDays / daysPerYear);
            remainingDays %= daysPerYear;
            const months = Math.floor(remainingDays / daysPerMonth);
            remainingDays %= daysPerMonth;
            const weeks = Math.floor(remainingDays / daysPerWeek);
            remainingDays %= daysPerWeek;
            const days = Math.floor(remainingDays);
            let parts = [];
            if (years > 0) parts.push(`${years} a√±o${years > 1 ? 's' : ''}`);
            if (months > 0) parts.push(`${months} mes${months > 1 ? 'es' : ''}`);
            if (weeks > 0) parts.push(`${weeks} semana${weeks > 1 ? 's' : ''}`);
            if (days > 0) parts.push(`${days} d√≠a${days > 1 ? 's' : ''}`);
            if (parts.length === 0) return '';
            return `(${parts.join(' ')})`;
        }

        function renderTable() {
            try {
                // Selecci√≥n defensiva de elementos
                const tbody = document.getElementById('tableBody') || document.querySelector('#table tbody');
                const tfoot = document.querySelector('#table tfoot');
                const tableHeader = document.getElementById('tableHeader') || document.querySelector('.table-header');

                if (!tbody) { console.error('Error cr√≠tico: No se encuentra tbody'); return; }
                if (!tfoot) { console.error('Error cr√≠tico: No se encuentra tfoot'); return; }
                if (!tableHeader) { console.error('Error cr√≠tico: No se encuentra tableHeader'); return; }

                tbody.innerHTML = '';

                // Actualizar header din√°micamente seg√∫n modo edici√≥n
                if (isEditMode) {
                    tableHeader.innerHTML = `
                    <tr>
                        <th>NOMBRE</th>
                        <th>TEN√çA</th>
                        <th>TIENE</th>
                        <th>SEMANAL</th>
                        <th>√ò DIARIO</th>
                        <th>%META</th>
                        <th>ACUMULADO</th>
                        <th>TOTAL</th>
                        <th>ACCIONES</th>
                    </tr>
                `;
                } else {
                    tableHeader.innerHTML = `
                    <tr>
                        <th>NOMBRE</th>
                        <th>TEN√çA</th>
                        <th>TIENE</th>
                        <th>SEMANAL</th>
                        <th>√ò DIARIO</th>
                        <th>%META</th>
                        <th>ACUMULADO</th>
                        <th>TOTAL</th>
                    </tr>
                `;
                }

                const playerNames = Object.keys(players);
                if (playerNames.length === 0) {
                    const colspan = isEditMode ? 9 : 8;
                    tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; padding: 40px; color: #6c757d;">No hay datos. Inicia sesi√≥n como admin para a√±adir jugadores.</td></tr>`;
                    tfoot.innerHTML = '';
                    return;
                }

                const sorted = playerNames.sort((a, b) => {
                    const playerA = players[a], playerB = players[b];
                    const aIsAbsent = playerA.absent || false, bIsAbsent = playerB.absent || false;
                    if (aIsAbsent !== bIsAbsent) return aIsAbsent ? 1 : -1;
                    if (aIsAbsent && bIsAbsent) return a.localeCompare(b);
                    const aTotal = playerA?.total || 0, bTotal = playerB?.total || 0;
                    return bTotal - aTotal;
                });

                let maxWeeklyDonation = 0;
                sorted.forEach(name => {
                    const player = players[name];
                    const semanal = (player.current || 0) - (player.previous || 0);
                    if (!player.absent && semanal > maxWeeklyDonation) maxWeeklyDonation = semanal;
                });

                let totalSemanal = 0, totalAcumulado = 0, totalAcumuladoExceso = 0, playersActive = 0, activePlayerRank = 0;

                sorted.forEach(name => {
                    const player = players[name];
                    if (!player) return;
                    player.weeklyTotal = (player.current || 0) - (player.previous || 0);
                    player.accumulatedExcess = player.accumulatedExcess || 0;
                    player.isNew = player.isNew || false;
                    const row = tbody.insertRow();

                    if (player.absent) {
                        row.className = 'absent-player';
                        const colspan = isEditMode ? 8 : 7;
                        row.innerHTML = `<td>${name}</td><td colspan="${colspan}">‚ùå Baneado</td>`;
                        return;
                    }

                    if (player.isNew) {
                        if (isEditMode) {
                            row.innerHTML = `<td style="font-weight: 500; text-align: center;">${name}<br><span style="color: #28a745; font-size: 0.9em; font-weight: bold;">NUEVO</span></td><td>-</td><td>${formatNumber(player.current || 0)}</td><td>0</td><td>0</td><td>0%</td><td>0</td><td>0</td><td></td>`;
                        } else {
                            row.innerHTML = `<td style="font-weight: 500; text-align: center;">${name}<br><span style="color: #28a745; font-size: 0.9em; font-weight: bold;">NUEVO</span></td><td>-</td><td>${formatNumber(player.current || 0)}</td><td>0</td><td>0</td><td>0%</td><td>0</td><td>0</td>`;
                        }
                        return;
                    }

                    // Si est√° en modo edici√≥n para este jugador
                    if (editingPlayer === name) {
                        const semanal = (player.current || 0) - (player.previous || 0);
                        const weeklyGoal = goalDaily * 7;
                        const weeklyExcess = Math.max(0, semanal - weeklyGoal);
                        const weeklyDeficit = Math.max(0, weeklyGoal - semanal);
                        const availableExcess = Math.max(0, player.accumulatedExcess || 0);
                        const deficitDraw = Math.min(weeklyDeficit, availableExcess);
                        const finalPotentialExcess = availableExcess - deficitDraw + weeklyExcess;

                        const calc = calculatePercentages(player);

                        let nameHtml = name;
                        if (activePlayerRank <= 5) {
                            const starColors = ['#FFD700', '#FFC107', '#FFFF00', '#FFFFE0', '#FFFACD'];
                            const starIcons = ['üåü', '‚ú∂', '‚òÖ', '‚ú∂', '‚≠ë'];
                            const rank = activePlayerRank - 1;
                            const starShadow = '-1px -1px 0 #4A4A4A, 1px -1px 0 #4A4A4A, -1px 1px 0 #4A4A4A, 1px 1px 0 #4A4A4A';
                            let currentStarFontSize = activePlayerRank === 2 ? '20px' : '18px';
                            nameHtml += `<span style="position: absolute; top: 1px; right: 4px; font-size: ${currentStarFontSize}; color: ${starColors[rank]}; text-shadow: ${starShadow};" title="Top ${activePlayerRank} donador total">${starIcons[rank]}</span>`;
                        }

                        row.innerHTML = `
                        <td style="font-weight: 600; padding: 16px 5px; position: relative;">
                            <input type="text" id="edit-name-${name}" value="${name}"
                                   style="width: 100%; padding: 6px 8px; border: 2px solid #007bff; border-radius: 6px; font-size: inherit; font-weight: 600; background: #e7f3ff; color: #333;">
                        </td>
                        <td>
                            <input type="number" id="edit-previous-${name}" value="${player.previous || 0}"
                                   style="width: 100%; padding: 6px 8px; border: 2px solid #007bff; border-radius: 6px; font-size: inherit; font-weight: 600; background: #e7f3ff; color: #333;">
                        </td>
                        <td>
                            <input type="number" id="edit-current-${name}" value="${player.current || 0}"
                                   style="width: 100%; padding: 6px 8px; border: 2px solid #007bff; border-radius: 6px; font-size: inherit; font-weight: 600; background: #e7f3ff; color: #333;">
                        </td>
                        <td style="background: #f8f9fa; color: #6c757d; font-style: italic; font-size: clamp(9px, 2.2vw, 11px);">
                            ${formatNumber(calc.semanal)}
                        </td>
                        <td style="background: #f8f9fa; color: #6c757d; font-style: italic; font-size: clamp(9px, 2.2vw, 11px);">
                            ${formatNumber(calc.avgDaily)}
                        </td>
                        <td style="background: #f8f9fa; color: #6c757d; font-style: italic; font-size: clamp(9px, 2.2vw, 11px);">
                            ${calc.metaPerc.toFixed(1)}%
                        </td>
                        <td>
                            <input type="number" id="edit-accumulated-${name}" value="${player.accumulatedExcess || 0}"
                                   style="width: 100%; padding: 6px 8px; border: 2px solid #007bff; border-radius: 6px; font-size: inherit; font-weight: 600; background: #e7f3ff; color: #333;">
                        </td>
                        <td style="background: #f8f9fa; color: #6c757d; font-style: italic; font-size: clamp(9px, 2.2vw, 11px);">
                            ${formatNumber(player.total || 0)}
                        </td>
                        <td style="text-align: center; padding: clamp(4px, 1vw, 8px);">
                            <button class="btn-save" onclick="saveEditing()" title="Guardar" style="margin-right: clamp(2px, 0.5vw, 4px); font-size: clamp(12px, 3vw, 16px); padding: clamp(4px, 1vw, 8px);">‚úì</button>
                            <button class="btn btn-cancel" onclick="cancelEditing()" title="Cancelar" style="font-size: clamp(12px, 3vw, 16px); padding: clamp(4px, 1vw, 8px);">‚úó</button>
                        </td>
                    `;
                        return;
                    }

                    playersActive++;
                    activePlayerRank++;
                    let nameHtml = name;
                    if (activePlayerRank <= 5) {
                        const starColors = ['#FFD700', '#FFC107', '#FFFF00', '#FFFFE0', '#FFFACD'];
                        const starIcons = ['üåü', '‚ú∂', '‚òÖ', '‚ú∂', '‚≠ë'];
                        const rank = activePlayerRank - 1;
                        const starShadow = '-1px -1px 0 #4A4A4A, 1px -1px 0 #4A4A4A, -1px 1px 0 #4A4A4A, 1px 1px 0 #4A4A4A';
                        let currentStarFontSize = activePlayerRank === 2 ? '20px' : '18px';
                        nameHtml += `<span style="position: absolute; top: 1px; right: 4px; font-size: ${currentStarFontSize}; color: ${starColors[rank]}; text-shadow: ${starShadow};" title="Top ${activePlayerRank} donador total">${starIcons[rank]}</span>`;
                    }

                    const semanal = (player.current || 0) - (player.previous || 0);
                    const weeklyGoal = goalDaily * 7;
                    const weeklyExcess = Math.max(0, semanal - weeklyGoal);
                    const weeklyDeficit = Math.max(0, weeklyGoal - semanal);
                    const availableExcess = Math.max(0, player.accumulatedExcess || 0);
                    const deficitDraw = Math.min(weeklyDeficit, availableExcess);
                    const finalPotentialExcess = availableExcess - deficitDraw + weeklyExcess;

                    const calc = calculatePercentages(player);
                    let metaContent = `${calc.metaPerc.toFixed(1)}%`;
                    if (maxWeeklyDonation > 0 && (player.current - player.previous) === maxWeeklyDonation) {
                        metaContent += ' <span title="Mayor donaci√≥n de la semana">‚≠ê</span>';
                    }

                    let deficitHtml = '';
                    if (deficitDraw > 0) {
                        deficitHtml = `<br/><span style="color: red;">(-${formatNumber(deficitDraw)})</span>`;
                    }

                    totalSemanal += calc.semanal;
                    totalAcumulado += (player.total || 0);
                    totalAcumuladoExceso += finalPotentialExcess;

                    // Calculo de Color de Nivel de Acumulado (Tier Color)
                    const oneWeekC = (goalDaily || 0) * 7;
                    const oneMonthC = oneWeekC * 4;
                    const acc = finalPotentialExcess;
                    let tierColor = '#28a745'; // Default Green (Tier 1)
                    let tierTitle = 'Nivel Verde: Eficiencia 100%';

                    if (acc >= (oneMonthC * 5)) {
                        tierColor = '#343a40'; // Black (Tier 4)
                        tierTitle = 'Nivel Tope: Eficiencia 5%';
                    } else if (acc >= (oneMonthC * 3)) {
                        tierColor = '#dc3545'; // Red (Tier 3)
                        tierTitle = 'Nivel Rojo: Eficiencia 10%';
                    } else if (acc >= oneMonthC) {
                        tierColor = '#ffc107'; // Yellow (Tier 2)
                        tierTitle = 'Nivel Amarillo: Eficiencia 50%';
                    }

                    // Estilo para la celda con borde izquierdo
                    const accStyle = `border-left: 5px solid ${tierColor} !important; padding-left: 8px;`;

                    if (isEditMode && auth.currentUser) {
                        const actionsHtml = `<td style="text-align: center; padding: 8px;">
                        <button class="btn btn-edit" onclick="enableEditing('${name}')" title="Editar jugador">‚úèÔ∏è</button>
                    </td>`;
                        row.innerHTML = `<td style="font-weight: 600; padding: 16px 5px; position: relative;">${nameHtml}</td><td>${formatNumber(player.previous || 0)}</td><td>${formatNumber(player.current || 0)}</td><td class="${getColorClass(calc.metaPerc, 'percentage')}">${formatNumber(calc.semanal)}</td><td class="${getColorClass(calc.avgDailyPerc, 'percentage')}">${formatNumber(calc.avgDaily)}</td><td class="${getColorClass(calc.metaPerc, 'percentage')}">${metaContent}</td><td style="${accStyle}" title="${tierTitle}">${formatNumber(finalPotentialExcess)}${deficitHtml}${formatExtraDonationTime(finalPotentialExcess / (goalDaily || 1))}</td><td class="${getColorClass(calc.totalPerc, 'total')}">${formatNumber(player.total || 0)}</td>${actionsHtml}`;
                    } else {
                        row.innerHTML = `<td style="font-weight: 600; padding: 16px 5px; position: relative;">${nameHtml}</td><td>${formatNumber(player.previous || 0)}</td><td>${formatNumber(player.current || 0)}</td><td class="${getColorClass(calc.metaPerc, 'percentage')}">${formatNumber(calc.semanal)}</td><td class="${getColorClass(calc.avgDailyPerc, 'percentage')}">${formatNumber(calc.avgDaily)}</td><td class="${getColorClass(calc.metaPerc, 'percentage')}">${metaContent}</td><td style="${accStyle}" title="${tierTitle}">${formatNumber(finalPotentialExcess)}${deficitHtml}${formatExtraDonationTime(finalPotentialExcess / (goalDaily || 1))}</td><td class="${getColorClass(calc.totalPerc, 'total')}">${formatNumber(player.total || 0)}</td>`;
                    }

                    // Mostrar vista previa si hay cambios pendientes para este jugador (solo admin)
                    if (previewData && previewData[name] && auth.currentUser) {
                        const previewPlayer = previewData[name];
                        const previewRow = tbody.insertRow();

                        // Determinar el tipo de fila de preview seg√∫n el estado del jugador
                        let previewClass = 'preview-row';
                        let previewLabelText = 'VISTA PREVIA';
                        let previewLabelClass = 'preview-label';

                        if (previewPlayer.willBeBanned) {
                            previewClass = 'preview-row-banned';
                            previewLabelText = 'SER√Å BANEADO';
                            previewLabelClass = 'preview-label-banned';
                        } else if (previewPlayer.isNew) {
                            previewClass = 'preview-row-new';
                            previewLabelText = 'NUEVO';
                            previewLabelClass = 'preview-label-new';
                        }

                        previewRow.className = previewClass;

                        // Para jugadores baneados, mostrar datos simplificados
                        if (previewPlayer.willBeBanned) {
                            const colspan = isEditMode ? 9 : 8;
                            previewRow.innerHTML = `
                            <td><span class="${previewLabelClass}">${previewLabelText}</span> ${name}</td>
                            <td colspan="${colspan - 1}" style="text-align: center; font-style: italic;">
                                Este jugador no aparece en los datos nuevos y ser√° marcado como ausente
                            </td>
                        `;
                        } else {
                            const previewCalc = calculatePercentages(previewPlayer);
                            // Los valores ya vienen calculados correctamente desde updateManualPreview
                            // No necesitamos recalcular el futuro, solo mostrarlo.
                            const finalAccumulated = previewPlayer.accumulatedExcess || 0;
                            const deficitDraw = previewPlayer.simulatedDeficitDraw || 0;

                            // CORRECCI√ìN: El porcentaje debe reflejar la donaci√≥n efectiva (Lo donado + Lo cubierto con acumulado)
                            const weeklyGoal = (goalDaily || 0) * 7;
                            const effectiveDonation = (previewPlayer.weeklyTotal || 0) + deficitDraw;
                            // NO limitar al 100%. Si don√≥ de m√°s, debe verse. El deficitDraw ya asegura que no se pase de 100% A MENOS que sea por donaci√≥n real.
                            const effectiveMetaPerc = (effectiveDonation / weeklyGoal) * 100;

                            previewRow.innerHTML = `
                            <td><span class="${previewLabelClass}">${previewLabelText}</span> ${name}</td>
                            <td>${formatNumber(previewPlayer.previous || 0)}</td>
                            <td>${formatNumber(previewPlayer.current || 0)}</td>
                            <td class="${getColorClass(previewCalc.metaPerc, 'percentage')}">${formatNumber(previewCalc.semanal)}</td>
                            <td class="${getColorClass(previewCalc.avgDailyPerc, 'percentage')}">${formatNumber(previewCalc.avgDaily)}</td>
                            <td class="${getColorClass(effectiveMetaPerc, 'percentage')}">${effectiveMetaPerc.toFixed(1)}%</td>
                            <td>${formatNumber(finalAccumulated)}${deficitDraw > 0 ? `<br/><span style="color: red;">(-${formatNumber(deficitDraw)})</span>` : ''}</td>
                            <td class="${getColorClass(previewCalc.totalPerc, 'total')}">${formatNumber(previewPlayer.total || 0)}</td>
                            ${isEditMode ? '<td></td>' : ''}
                        `;
                        }
                    }
                });

                // Mostrar jugadores en preview que no est√°n en la tabla actual (nuevos y baneados adicionales)
                if (previewData && auth.currentUser) {
                    Object.keys(previewData).forEach(name => {
                        // Solo mostrar si no est√° en players actual o si est√° marcado para ser baneado
                        const previewPlayer = previewData[name];
                        const isNewPlayer = previewPlayer.isNew;
                        const willBeBanned = previewPlayer.willBeBanned;

                        // Si es nuevo o ser√° baneado y no se mostr√≥ antes
                        if ((isNewPlayer || willBeBanned) && !players[name]) {
                            const previewRow = tbody.insertRow();

                            let previewClass = 'preview-row-new';
                            let previewLabelText = 'NUEVO';
                            let previewLabelClass = 'preview-label-new';

                            if (willBeBanned) {
                                previewClass = 'preview-row-banned';
                                previewLabelText = 'SER√Å BANEADO';
                                previewLabelClass = 'preview-label-banned';
                            }

                            previewRow.className = previewClass;

                            // Para jugadores baneados, mostrar mensaje simplificado
                            if (willBeBanned) {
                                const colspan = isEditMode ? 9 : 8;
                                previewRow.innerHTML = `
                                <td><span class="${previewLabelClass}">${previewLabelText}</span> ${name}</td>
                                <td colspan="${colspan - 1}" style="text-align: center; font-style: italic;">
                                    Este jugador no aparece en los datos nuevos y ser√° marcado como ausente
                                </td>
                            `;
                            } else {
                                // Para jugadores nuevos, NO mostrar c√°lculos (son base 0)
                                // Alinear con el comportamiento de la tabla principal para isNew
                                const finalAccumulated = previewPlayer.accumulatedExcess || 0;
                                // Mostrar el valor ingresado en "Tiene" y "-" en "Ten√≠a", o 0 en ambos stats

                                const colspan = isEditMode ? 9 : 8;

                                // Opci√≥n: Mostrar igual que en la tabla principal
                                // <td>NUEVO {name}</td> <td>-</td> <td>{current}</td> <td>0</td> ...

                                previewRow.innerHTML = `
                                <td><span class="${previewLabelClass}">${previewLabelText}</span> ${name}</td>
                                <td>-</td>
                                <td>${formatNumber(previewPlayer.current || 0)}</td>
                                <td class="percentage">0</td>
                                <td class="percentage">0</td>
                                <td class="percentage">0.0%</td>
                                <td>0</td>
                                <td class="total">0</td>
                                ${isEditMode ? '<td></td>' : ''}
                            `;
                            }
                        }
                    });
                }

                const avgSemanal = playersActive > 0 ? totalSemanal / playersActive : 0;
                const colspan = isEditMode ? 9 : 8;

                let footerContent = `üìä TOTALES (${playersActive} jugadores): ${formatNumber(totalSemanal)} donaciones semanales | Promedio: ${formatNumber(avgSemanal)} | Acumulado: ${formatNumber(totalAcumulado)}`;

                // Agregar resumen de cambios en preview
                if (previewData && auth.currentUser) {
                    const newPlayersCount = Object.keys(previewData).filter(name => previewData[name].isNew).length;
                    const bannedPlayersCount = Object.keys(previewData).filter(name => previewData[name].willBeBanned).length;

                    if (newPlayersCount > 0 || bannedPlayersCount > 0) {
                        const previewSummary = [];
                        if (newPlayersCount > 0) previewSummary.push(`<span style="color: #155724;">+${newPlayersCount} nuevos</span>`);
                        if (bannedPlayersCount > 0) previewSummary.push(`<span style="color: #721c24;">-${bannedPlayersCount} baneados</span>`);
                        footerContent += ` | <span style="font-weight: bold;">üìã VISTA PREVIA: ${previewSummary.join(' | ')}</span>`;
                    }
                }

                tfoot.innerHTML = `<tr class="total-row"><td colspan="${colspan}">${footerContent}</td></tr>`;
            } catch (error) {
                console.error("Error cr√≠tico en renderTable:", error);
            }


        }



        // --- FUNCIONES DE EDICI√ìN INLINE (ADMIN) ---

        let editingPlayer = null;
        let isEditMode = false;

        function toggleEditMode() {
            if (!auth.currentUser) return showLogin();

            isEditMode = !isEditMode;
            const btn = document.getElementById('editModeBtn');

            if (isEditMode) {
                btn.classList.add('active');
                btn.textContent = '‚úèÔ∏è';
                showStatus('‚úèÔ∏è Modo edici√≥n activado. Usa los botones ‚úèÔ∏è para editar jugadores.', 'success');
            } else {
                btn.classList.remove('active');
                btn.textContent = 'üìù';
                editingPlayer = null;
                showStatus('‚ùå Modo edici√≥n desactivado', 'success');
            }

            renderTable();
        }

        // Referencia a Firestore (db es la variable global)

        // --- L√ìGICA DE TIEMPO Y SINCRONIZACI√ìN ---

        function updateTimeDisplays() {
            if (!lastUpdate) return;
            const date = new Date(lastUpdate);

            // Formato para el Header: "Mi√©rcoles 13"
            const optionsHeader = { weekday: 'long', day: 'numeric' };
            let headerText = date.toLocaleDateString('es-ES', optionsHeader);
            // Capitalizar la primera letra
            headerText = headerText.charAt(0).toUpperCase() + headerText.slice(1);

            // Elemento del header
            const headerEl = document.getElementById('headerLastUpdate');
            if (headerEl) {
                headerEl.textContent = `√öltima actualizaci√≥n: ${headerText}`;

                // Indicador visual sutil si est√° muy desactualizado (> 24h)
                const now = new Date();
                const diffHours = (now - date) / (1000 * 60 * 60);
                if (diffHours > 24) {
                    headerEl.style.color = '#ffeba7'; // Amarillo suave
                } else {
                    headerEl.style.color = 'rgba(255, 255, 255, 0.9)';
                }
            }

            // Actualizar footer
            const lastUpdateEl = document.getElementById('lastUpdateTime');
            const weekStartEl = document.getElementById('weekStartTime');
            if (lastUpdateEl) lastUpdateEl.textContent = new Date(lastUpdate).toLocaleString('es-ES');
            if (weekStartEl) weekStartEl.textContent = new Date(weekStart).toLocaleDateString('es-ES');
        }

        // --- SISTEMA SMART SYNC ---

        // Variable para controlar si hay actualizaci√≥n de SW o Datos
        let hasAppUpdate = false;
        let hasDataUpdate = false;

        function smartSyncAction() {
            // Ahora simplemente abre el men√∫ de opciones modernos
            showSyncOptions();
        }

        // --- FUNCIONES DEL NUEVO MEN√ö DE SINCRONIZACI√ìN (MODAL) ---

        function showSyncOptions() {
            hideAllSections();
            const modal = document.getElementById('syncOptionsModal');
            const btnUpdate = document.getElementById('btnUpdateApp');

            if (modal) {
                // Mostrar bot√≥n de actualizaci√≥n solo si es necesario
                if (hasAppUpdate && btnUpdate) {
                    btnUpdate.style.display = 'flex';
                } else if (btnUpdate) {
                    btnUpdate.style.display = 'none';
                }
                modal.classList.add('active');
            }
        }

        function hideSyncOptions() {
            const modal = document.getElementById('syncOptionsModal');
            if (modal) modal.classList.remove('active');
        }

        function executeSync(action) {
            hideSyncOptions();

            switch (action) {
                case 'UPDATE_APP':
                    if (confirm('üöÄ ¬øConfirmas que quieres actualizar la App?')) {
                        if (navigator.serviceWorker && navigator.serviceWorker.getRegistration()) {
                            navigator.serviceWorker.getRegistration().then(reg => {
                                if (reg && reg.waiting) {
                                    reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                                    window.location.reload();
                                } else {
                                    window.location.reload();
                                }
                            });
                        } else {
                            window.location.reload();
                        }
                    }
                    break;

                case 'SYNC_DATA':
                    showStatus('üîÑ Buscando datos recientes...', 'success');
                    forceSync();
                    break;

                case 'REPAIR':
                    if (confirm('‚ö†Ô∏è ¬øSeguro que quieres borrar la cach√© y recargar?')) {
                        forceClearCache();
                    }
                    break;
            }
        }

        function forceClearCache() {
            showStatus('üßπ Limpiando cach√© y recargando...', 'success');
            // Desregistrar Service Workers
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function (registrations) {
                    for (let registration of registrations) {
                        registration.unregister();
                    }
                    // Borrar cach√©s
                    if ('caches' in window) {
                        caches.keys().then(function (names) {
                            for (let name of names) {
                                caches.delete(name);
                            }
                            window.location.reload(true);
                        });
                    } else {
                        window.location.reload(true);
                    }
                });
            } else {
                window.location.reload(true);
            }
        }

        function toggleSmartSyncIndicator(show) {
            const btn = document.getElementById('smartSyncBtn');
            if (btn) {
                if (show) btn.classList.add('has-update');
                else btn.classList.remove('has-update');
            }
        }

        // Modificar forceSync original para que apague el indicador si tiene √©xito
        const originalForceSync = forceSync;
        forceSync = function () { // Reemplazamos la referencia global si existe, o definimos wrapper
            // L√≥gica de sincronizaci√≥n de datos existente
            loadFromFirebase(true).then(() => {
                hasDataUpdate = false; // Reset flag
                toggleSmartSyncIndicator(hasAppUpdate); // Mantener solo si hay app update
            });
        };

        // Escuchar cambios en Firestore para activar el punto rojo
        if (db) {
            db.collection("config").doc("global").onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    const cloudTime = data.lastUpdate; // Timestamp

                    // Si la fecha de la nube es m√°s nueva que la local
                    if (cloudTime && lastUpdate && cloudTime > lastUpdate + 1000) { // 1s margen
                        console.log('üîî Dato nuevo detectado en nube');
                        hasDataUpdate = true;
                        toggleSmartSyncIndicator(true);
                        showStatus('üîî Nuevos datos disponibles', 'success');
                    }
                }
            });
        }

        // --- FIN SISTEMA SMART SYNC ---

        // Funci√≥n original modificada para llamar a updateTimeDisplays


        function updateEditModeButton() {
            const btn = document.getElementById('editModeBtn');
            if (!btn) return;

            if (auth.currentUser) {
                btn.style.display = 'flex';
            } else {
                btn.style.display = 'none';
                isEditMode = false;
                btn.classList.remove('active');
                btn.textContent = 'üìù';
            }
        }

        function enableEditing(playerName) {
            if (!auth.currentUser) return showLogin();

            isEditMode = false;
            const btn = document.getElementById('editModeBtn');
            if (btn) {
                btn.classList.remove('active');
                btn.textContent = 'üìù';
            }

            editingPlayer = playerName;
            renderTable();
            showStatus('‚úèÔ∏è Editando jugador: ' + playerName, 'processing');
        }

        function updatePreviewForEditing() {
            // Esta funci√≥n es necesaria para que los inputs no lancen error al escribir.
            // Por ahora, no forzamos re-render para evitar perder el foco del cursor.
            if (!editingPlayer) return;

            // Opcional: Aqu√≠ podr√≠amos actualizar manualmente las celdas calculadas (Semanal, %) 
            // accediendo al DOM sin redibujar toda la tabla.
        }

        function cancelEditing() {
            editingPlayer = null;
            previewData = null; // Limpiar vista previa al cancelar
            renderTable();
            showStatus('‚ùå Edici√≥n cancelada', 'success');
        }

        function saveEditing() {
            if (!editingPlayer || !auth.currentUser) return;

            const newNameInput = document.getElementById(`edit-name-${editingPlayer}`);
            const newPrevInput = document.getElementById(`edit-previous-${editingPlayer}`);
            const newCurrInput = document.getElementById(`edit-current-${editingPlayer}`);
            const newAccInput = document.getElementById(`edit-accumulated-${editingPlayer}`);

            if (!newNameInput || !newPrevInput || !newCurrInput) {
                showStatus('‚ùå Error: No se encontraron campos de edici√≥n', 'error');
                return;
            }

            const newName = newNameInput.value.trim();
            const newPrev = parseInt(newPrevInput.value);
            const newCurr = parseInt(newCurrInput.value);
            const newAcc = newAccInput ? parseInt(newAccInput.value) : (players[editingPlayer].accumulatedExcess || 0);

            if (!newName) {
                showStatus('‚ùå El nombre no puede estar vac√≠o', 'error');
                return;
            }

            if (isNaN(newPrev) || newPrev < 0) {
                showStatus('‚ùå "Ten√≠a" debe ser un n√∫mero v√°lido (>= 0)', 'error');
                return;
            }

            if (isNaN(newCurr) || newCurr < 0) {
                showStatus('‚ùå "Tiene" debe ser un n√∫mero v√°lido (>= 0)', 'error');
                return;
            }

            if (newName !== editingPlayer && players[newName]) {
                showStatus('‚ùå Ya existe un jugador con ese nombre', 'error');
                return;
            }

            if (newName !== editingPlayer) {
                players[newName] = { ...players[editingPlayer] };
                delete players[editingPlayer];
                editingPlayer = newName;
            }

            players[editingPlayer].previous = newPrev;
            players[editingPlayer].current = newCurr;
            players[editingPlayer].accumulatedExcess = newAcc;

            editingPlayer = null;
            previewData = null; // Limpiar vista previa despu√©s de guardar
            showUnsavedIndicator();
            renderTable();
            showStatus('‚úÖ Cambios guardados. Recuerda pulsar "‚úì" para guardar en Firebase', 'success');
        }

        // --- FUNCIONES DE ACTUALIZACI√ìN DE DATOS (ADMIN) ---

        function updatePlayers(currentData) {
            if (!auth.currentUser) return;
            if (!currentData || Object.keys(currentData).length === 0) {
                showStatus('‚ùå No hay datos para procesar', 'error');
                return;
            }

            const namesToDelete = Object.keys(players).filter(name => players[name].absent);
            namesToDelete.forEach(name => { delete players[name]; });

            Object.keys(players).forEach(name => {
                if (!currentData[name]) players[name].absent = true;
            });

            Object.keys(currentData).forEach(name => {
                const current = currentData[name];
                if (!players[name]) {
                    players[name] = { previous: 0, current: current, initialDonation: current, total: 0, weeklyTotal: 0, accumulatedExcess: 0, lastSeen: Date.now(), absent: false, isNew: true };
                } else {
                    players[name].absent = false;
                    const previousCurrent = players[name].current || 0;
                    const current = current;

                    if (current < previousCurrent) {
                        showStatus(`‚ö†Ô∏è Error: ${name} tiene un valor menor al anterior (${current} < ${previousCurrent})`, 'error');
                        return;
                    }

                    const difference = current - previousCurrent;
                    players[name].previous = previousCurrent;
                    players[name].current = current;
                    players[name].lastSeen = Date.now();
                    players[name].total += difference;
                    players[name].isNew = false;
                }
            });

            showUnsavedIndicator();
            renderTable();
        }

        async function startNewWeek() {
            if (!auth.currentUser) return;

            let maxWeekly = 0;
            let starHolders = [];
            Object.values(players).forEach(player => {
                if (!player.absent && (player.weeklyTotal || 0) > maxWeekly) maxWeekly = player.weeklyTotal;
            });

            if (maxWeekly > 0) {
                Object.keys(players).forEach(name => {
                    if (!players[name].absent && players[name].weeklyTotal === maxWeekly) starHolders.push(name);
                });
            }

            const weeklyGoal = goalDaily * 7;
            Object.keys(players).forEach(name => {
                const player = players[name];
                player.hasWeeklyStar = starHolders.includes(name);
                if (player.absent) return;
                const weeklyDonation = player.weeklyTotal || 0;
                if (weeklyDonation >= weeklyGoal) {
                    player.accumulatedExcess = (player.accumulatedExcess || 0) + (weeklyDonation - weeklyGoal);
                } else {
                    const deficit = weeklyGoal - weeklyDonation;
                    const availableExcess = Math.max(0, player.accumulatedExcess || 0);
                    const amountToDeduct = Math.min(deficit, availableExcess);
                    player.accumulatedExcess = availableExcess - amountToDeduct;
                }
                player.weeklyTotal = 0;
            });

            weekStart = getWeekStart();
            showUnsavedIndicator();
            renderTable();
            showStatus('üîÑ Nueva semana iniciada correctamente (recuerda guardar en Firebase)', 'success');
        }

        function levenshteinDistance(str1, str2) {
            if (!editingPlayer || !auth.currentUser) return;

            const newNameInput = document.getElementById(`edit-name-${editingPlayer}`);
            const newPrevInput = document.getElementById(`edit-previous-${editingPlayer}`);
            const newCurrInput = document.getElementById(`edit-current-${editingPlayer}`);

            if (!newNameInput || !newPrevInput || !newCurrInput) {
                showStatus('‚ùå Error: No se encontraron campos de edici√≥n', 'error');
                return;
            }

            const newName = newNameInput.value.trim();
            const newPrev = parseInt(newPrevInput.value);
            const newCurr = parseInt(newCurrInput.value);

            if (!newName) {
                showStatus('‚ùå El nombre no puede estar vac√≠o', 'error');
                return;
            }

            if (isNaN(newPrev) || newPrev < 0) {
                showStatus('‚ùå "Ten√≠a" debe ser un n√∫mero v√°lido (>= 0)', 'error');
                return;
            }

            if (isNaN(newCurr) || newCurr < 0) {
                showStatus('‚ùå "Tiene" debe ser un n√∫mero v√°lido (>= 0)', 'error');
                return;
            }

            if (newName !== editingPlayer && players[newName]) {
                showStatus('‚ùå Ya existe un jugador con ese nombre', 'error');
                return;
            }

            if (newName !== editingPlayer) {
                players[newName] = { ...players[editingPlayer] };
                delete players[editingPlayer];
                editingPlayer = newName;
            }

            players[editingPlayer].previous = newPrev;
            players[editingPlayer].current = newCurr;

            editingPlayer = null;
            showUnsavedIndicator();
            renderTable();
            showStatus('‚úÖ Cambios guardados. Recuerda pulsar "‚úì" para guardar en Firebase', 'success');
        }

        // --- FUNCIONES DE ACTUALIZACI√ìN DE DATOS (ADMIN) ---

        function updatePlayers(currentData) {
            if (!auth.currentUser) return;
            if (!currentData || Object.keys(currentData).length === 0) {
                showStatus('‚ùå No hay datos para procesar', 'error');
                return;
            }

            const namesToDelete = Object.keys(players).filter(name => players[name].absent);
            namesToDelete.forEach(name => { delete players[name]; });

            Object.keys(players).forEach(name => {
                if (!currentData[name]) players[name].absent = true;
            });

            Object.keys(currentData).forEach(name => {
                const current = currentData[name];
                if (!players[name]) {
                    // FIX: Initialize total to current (since previous is 0) so the TOTAL column reflects this week's donation
                    players[name] = { previous: 0, current: current, initialDonation: current, total: current, weeklyTotal: 0, accumulatedExcess: 0, lastSeen: Date.now(), absent: false, isNew: true };
                } else {
                    players[name].absent = false;
                    const previousCurrent = players[name].current || 0;
                    const current = current;

                    if (current < previousCurrent) {
                        showStatus(`‚ö†Ô∏è Error: ${name} tiene un valor menor al anterior (${current} < ${previousCurrent})`, 'error');
                        return;
                    }

                    const difference = current - previousCurrent;
                    players[name].previous = previousCurrent;
                    players[name].current = current;
                    players[name].lastSeen = Date.now();
                    players[name].total += difference;
                    players[name].isNew = false;
                }
            });

            showUnsavedIndicator();
            renderTable();
        }

        async function startNewWeek() {
            if (!auth.currentUser) return;

            let maxWeekly = 0;
            let starHolders = [];
            Object.values(players).forEach(player => {
                if (!player.absent && (player.weeklyTotal || 0) > maxWeekly) maxWeekly = player.weeklyTotal;
            });

            if (maxWeekly > 0) {
                Object.keys(players).forEach(name => {
                    if (!players[name].absent && players[name].weeklyTotal === maxWeekly) starHolders.push(name);
                });
            }

            const weeklyGoal = goalDaily * 7;
            Object.keys(players).forEach(name => {
                const player = players[name];
                player.hasWeeklyStar = starHolders.includes(name);
                if (player.absent) return;
                const weeklyDonation = player.weeklyTotal || 0;
                if (weeklyDonation >= weeklyGoal) {
                    // L√≥gica de Rendimiento Decreciente (Escala de 4 Niveles - Sem√°foro + Plus)
                    const excess = weeklyDonation - weeklyGoal;
                    const oneWeek = goalDaily * 7;
                    const oneMonth = oneWeek * 4; // 1 mes = 4 semanas
                    const currentAccumulated = player.accumulatedExcess || 0;

                    let efficiency = 1.0;

                    if (currentAccumulated >= (oneMonth * 5)) {
                        efficiency = 0.05;  // > 5 Meses: 5% (Tier 4)
                    } else if (currentAccumulated >= (oneMonth * 3)) {
                        efficiency = 0.10;  // 3-5 Meses: 10% (Tier 3 - Rojo)
                    } else if (currentAccumulated >= oneMonth) {
                        efficiency = 0.50;  // 1-3 Meses: 50% (Tier 2 - Amarillo)
                    } else {
                        efficiency = 1.0;   // 0-1 Mes: 100% (Tier 1 - Verde)
                    }

                    const effectiveExcess = excess * efficiency;
                    player.accumulatedExcess = currentAccumulated + effectiveExcess;

                    console.log(`[Acumulado v3.6] Jugador: ${name} | Exceso: ${excess} | Nivel: ${(currentAccumulated / oneMonth).toFixed(1)}m | Eficiencia: ${(efficiency * 100)}% | Guardado: ${effectiveExcess}`);
                } else {
                    const deficit = weeklyGoal - weeklyDonation;
                    const availableExcess = Math.max(0, player.accumulatedExcess || 0);
                    const deduction = Math.min(deficit, availableExcess);
                    player.accumulatedExcess = availableExcess - deduction;
                }
                // RESET EFFECTIVE WEEKLY COUNTER
                // Set 'previous' to 'current' so that next week's calculation (Current - Previous) starts at 0
                player.previous = player.current || 0;
                player.weeklyTotal = 0;

                // FIX: Graduate new players to regular players so they show up correctly
                player.isNew = false;
            });

            weekStart = getWeekStart();
            showUnsavedIndicator();
            renderTable();
            showStatus('üîÑ Nueva semana iniciada correctamente (recuerda guardar en Firebase)', 'success');
        }

        function levenshteinDistance(str1, str2) {
            const m = str1.length;
            const n = str2.length;
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));

            for (let i = 0; i <= m; i++) dp[i][0] = i;
            for (let j = 0; j <= n; j++) dp[0][j] = j;

            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    if (str1[i - 1] === str2[j - 1]) {
                        dp[i][j] = dp[i - 1][j - 1];
                    } else {
                        dp[i][j] = Math.min(
                            dp[i - 1][j] + 1,
                            dp[i][j - 1] + 1,
                            dp[i - 1][j - 1] + 1
                        );
                    }
                }
            }

            return dp[m][n];
        }

        function calculateSimilarity(str1, str2) {
            const distance = levenshteinDistance(
                str1.toLowerCase(),
                str2.toLowerCase()
            );
            const maxLength = Math.max(str1.length, str2.length);
            if (maxLength === 0) return 100;
            return Math.round(((maxLength - distance) / maxLength) * 100);
        }

        function findSimilarNames(newName, existingNames, threshold = 70) {
            const similar = [];
            const newNameLower = newName.toLowerCase().trim();

            existingNames.forEach(existingName => {
                const similarity = calculateSimilarity(newName, existingName);
                if (similarity >= threshold) {
                    similar.push({
                        name: existingName,
                        similarity: similarity
                    });
                }
            });

            return similar.sort((a, b) => b.similarity - a.similarity);
        }

        let nameMapping = {};
        let currentDataForReview = {};

        function checkSimilarity() {
            const text = document.getElementById('manualInput').value.trim();
            if (!text) {
                showStatus('‚ùå Por favor ingresa algunos datos primero', 'error');
                return;
            }

            const currentData = {};
            const lines = text.split('\n');
            let processedCount = 0;
            let hasError = false;

            lines.forEach((line, index) => {
                line = line.trim();
                if (!line) return;
                const parts = line.split(',');
                if (parts.length !== 2) {
                    showStatus(`‚ùå Error en l√≠nea ${index + 1}: formato incorrecto.`, 'error');
                    hasError = true;
                    return;
                }
                const name = parts[0].trim();
                const num = parseInt(parts[1].trim());
                if (!name || isNaN(num) || num < 0) {
                    showStatus(`‚ùå Error en l√≠nea ${index + 1}: datos inv√°lidos.`, 'error');
                    hasError = true;
                    return;
                }
                currentData[name] = num;
                processedCount++;
            });

            if (hasError) return;

            if (processedCount === 0) {
                showStatus('‚ùå No hay datos v√°lidos para procesar', 'error');
                return;
            }

            const existingNames = Object.keys(players);
            const newNames = Object.keys(currentData).filter(name => !existingNames.includes(name));

            if (newNames.length === 0) {
                showStatus('‚úÖ Todos los nombres coinciden con usuarios existentes. Puedes proceder con "Iniciar Semana".', 'success');
                return;
            }

            reviewNames(currentData);
        }

        function reviewNames(currentData) {
            const existingNames = Object.keys(players);
            const newNames = Object.keys(currentData);

            nameMapping = {};
            currentDataForReview = { ...currentData };

            const reviewItemsList = document.getElementById('reviewItemsList');
            reviewItemsList.innerHTML = '';

            const reviewItems = [];

            newNames.forEach(newName => {
                const similarNames = findSimilarNames(newName, existingNames);

                const item = {
                    newName: newName,
                    donation: currentData[newName],
                    similarNames: similarNames,
                    selected: false,
                    actionType: null
                };

                if (similarNames.length > 0) {
                    const bestMatch = similarNames[0];
                    nameMapping[newName] = bestMatch.name;
                    item.selected = true;
                    item.actionType = 'assigned';
                    item.assignedTo = bestMatch.name;
                } else {
                    nameMapping[newName] = null;
                    item.selected = true;
                    item.actionType = 'new';
                }

                reviewItems.push(item);
            });

            reviewItems.sort((a, b) => {
                const aHasSim = a.similarNames.length > 0;
                const bHasSim = b.similarNames.length > 0;

                if (aHasSim && bHasSim) {
                    const aHasPerfect = a.similarNames.some(s => s.similarity === 100);
                    const bHasPerfect = b.similarNames.some(s => s.similarity === 100);

                    if (!aHasPerfect && bHasPerfect) return -1;
                    if (aHasPerfect && !bHasPerfect) return 1;
                    return b.similarNames[0].similarity - a.similarNames[0].similarity;
                }
                if (aHasSim && !bHasSim) return -1;
                if (!aHasSim && bHasSim) return 1;

                return a.newName.localeCompare(b.newName);
            });

            reviewItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'review-item';
                itemDiv.dataset.newName = item.newName;
                itemDiv.dataset.index = index;

                if (item.selected) {
                    itemDiv.classList.add('selected');
                }

                if (item.similarNames.length > 0) {
                    const hasPerfect = item.similarNames.some(s => s.similarity === 100);
                    itemDiv.classList.add(hasPerfect ? 'identical' : 'matched');
                } else {
                    itemDiv.classList.add('new');
                }

                let existingHtml = '<div class="review-name-section"><input type="text" class="review-name-input" style="background: #e7f3ff; border-color: #007bff;" value="-" onchange="updateExistingName(${index}, this.value)" placeholder="Existente" /></div>';

                if (item.similarNames.length > 0) {
                    const bestMatch = item.similarNames[0];
                    const isPerfect = bestMatch.similarity === 100;
                    existingHtml = `
                        <div class="review-name-section">
                            <input type="text" class="review-name-input" style="background: #e7f3ff; border-color: #007bff;" value="${bestMatch.name}" onchange="updateExistingName(${index}, this.value)" />
                            <span class="review-similarity ${isPerfect ? 'similarity-perfect' : 'similarity-medium'}">${bestMatch.similarity}%</span>
                        </div>
                    `;
                }

                let actionsHtml = '';
                if (item.selected && item.actionType === 'new') {
                    actionsHtml = `
                        <button class="btn-create-new" disabled>‚úì Nuevo</button>
                    `;
                } else if (item.selected && item.actionType === 'assigned') {
                    actionsHtml = `
                        <button class="btn-assign" disabled>‚úì Existente</button>
                        <button class="btn-create-new" onclick="markAsNew(${index})" data-index="${index}">
                            Nuevo
                        </button>
                    `;
                    item.similarNames.slice(1).forEach((similar, simIndex) => {
                        const adjustedIndex = simIndex + 1;
                        const isPerfect = similar.similarity === 100;
                        actionsHtml += `
                            <button class="btn-assign" onclick="assignUser(${index}, ${adjustedIndex})" data-index="${index}" data-sim-index="${adjustedIndex}">
                                Existente
                            </button>
                        `;
                    });
                } else if (item.similarNames.length > 0) {
                    item.similarNames.forEach((similar, simIndex) => {
                        const isPerfect = similar.similarity === 100;
                        actionsHtml += `
                            <button class="btn-assign" onclick="assignUser(${index}, ${simIndex})" data-index="${index}" data-sim-index="${simIndex}">
                                Existente
                            </button>
                        `;
                    });
                } else {
                    actionsHtml = `
                        <button class="btn-create-new" onclick="markAsNew(${index})" data-index="${index}">
                            Nuevo
                        </button>
                    `;
                }

                itemDiv.innerHTML = `
                    <div class="review-row">
                        ${existingHtml}
                        <div class="review-name-section">
                            <input type="text" class="review-name-input" style="background: #fffdf5; border-color: #ffc107;" value="${item.newName}" onchange="updateNewName(${index}, this.value)" />
                            <div class="review-donation">${formatNumber(item.donation)}</div>
                        </div>
                        <div class="review-actions">
                            ${actionsHtml}
                        </div>
                    </div>
                `;

                reviewItemsList.appendChild(itemDiv);
            });

            updateReviewSummary();

            hideAllSections();
            document.getElementById('reviewSection').classList.add('active');
        }

        function updateReviewSummary() {
            const newNames = Object.keys(currentDataForReview);
            const totalNames = newNames.length;
            const mappedNames = Object.keys(nameMapping).filter(name => nameMapping[name] !== null).length;
            const newUsersCount = Object.keys(nameMapping).filter(name => nameMapping[name] === null).length;
            const pendingCount = totalNames - mappedNames - newUsersCount;

            const summaryEl = document.getElementById('reviewSummary');
            summaryEl.innerHTML = `
                <strong>Resumen:</strong>
                ${totalNames} nombres totales |
                ${mappedNames} asignados a usuarios existentes |
                ${newUsersCount} nuevos usuarios |
                ${pendingCount} pendientes de revisi√≥n
            `;
        }

        function assignUser(itemIndex, simIndex) {
            const itemDiv = document.querySelector(`[data-index="${itemIndex}"]`);
            if (!itemDiv) return;

            const newName = itemDiv.dataset.newName;
            const existingInput = itemDiv.querySelector('.review-name-input');
            const existingName = existingInput ? existingInput.value : newName;

            nameMapping[newName] = existingName;
            itemDiv.dataset.assignedTo = existingName;

            itemDiv.classList.add('selected');
            itemDiv.classList.remove('matched', 'identical', 'new');

            const actionsSection = itemDiv.querySelector('.review-actions');
            let actionsHtml = '';
            actionsHtml += `
                <button class="btn-assign" disabled>‚úì Existente</button>
                <button class="btn-create-new" onclick="markAsNew(${itemIndex})" data-index="${itemIndex}">
                    Nuevo
                </button>
            `;
            actionsSection.innerHTML = actionsHtml;

            updateReviewSummary();
        }

        function markAsNew(itemIndex) {
            const itemDiv = document.querySelector(`[data-index="${itemIndex}"]`);
            if (!itemDiv) return;

            const newName = itemDiv.dataset.newName;
            nameMapping[newName] = null;

            itemDiv.classList.add('selected');
            itemDiv.classList.remove('matched', 'identical');
            itemDiv.classList.add('new');

            const actionsSection = itemDiv.querySelector('.review-actions');
            const actionsHtml = `
                <button class="btn-create-new" disabled>‚úì Nuevo</button>
            `;
            actionsSection.innerHTML = actionsHtml;

            updateReviewSummary();
        }

        function updateExistingName(itemIndex, newName) {
            const itemDiv = document.querySelector(`[data-index="${itemIndex}"]`);
            if (!itemDiv) return;

            const oldNewName = itemDiv.dataset.newName;
            nameMapping[oldNewName] = newName;
            itemDiv.dataset.assignedTo = newName;
            updateReviewSummary();
        }

        function updateNewName(itemIndex, newName) {
            const itemDiv = document.querySelector(`[data-index="${itemIndex}"]`);
            if (!itemDiv) return;

            const oldName = itemDiv.dataset.newName;
            itemDiv.dataset.newName = newName;

            const donation = currentDataForReview[oldName];
            delete currentDataForReview[oldName];
            currentDataForReview[newName] = donation;

            if (nameMapping.hasOwnProperty(oldName)) {
                nameMapping[newName] = nameMapping[oldName];
                delete nameMapping[oldName];
            }
            updateReviewSummary();
        }

        function hideReview() {
            document.getElementById('reviewSection').classList.remove('active');
            nameMapping = {};
            currentDataForReview = {};
        }

        async function confirmNameMapping() {
            const newNames = Object.keys(currentDataForReview);
            const pendingCount = newNames.filter(name => !nameMapping.hasOwnProperty(name)).length;

            if (pendingCount > 0) {
                if (!confirm(`A√∫n hay ${pendingCount} nombres pendientes de revisi√≥n. ¬øDeseas procesarlos como nuevos usuarios?`)) {
                    return;
                }

                newNames.forEach(name => {
                    if (!nameMapping.hasOwnProperty(name)) {
                        nameMapping[name] = null;
                    }
                });
            }

            const mappedData = {};
            Object.keys(currentDataForReview).forEach(newName => {
                const targetName = nameMapping[newName];
                const finalName = targetName || newName;
                mappedData[finalName] = currentDataForReview[newName];
            });

            hideReview();

            // Solo actualizar localmente
            updatePlayers(mappedData);
            hideManual();
            showStatus(`‚úÖ Datos importados localmente. Recuerda usar el bot√≥n ‚úì para guardar en la nube o iniciar semana.`, 'success');
        }

        async function processManual() {
            if (!auth.currentUser) {
                showStatus('‚ùå Debes iniciar sesi√≥n como admin.', 'error');
                return;
            }
            const text = document.getElementById('manualInput').value.trim();
            if (!text) {
                showStatus('‚ùå Por favor ingresa algunos datos', 'error');
                return;
            }

            // ELIMINADO: Confirmaci√≥n de nueva semana y llamada a startNewWeek
            // Ahora solo procesamos el texto y lo mandamos a revisar.

            const currentData = {};
            const lines = text.split('\n');
            let processedCount = 0;

            lines.forEach((line, index) => {
                line = line.trim();
                if (!line) return;
                const parts = line.split(',');
                if (parts.length !== 2) return; // Ignorar l√≠neas malformadas silenciosamente o loggear (?)
                // Mantengamos validaci√≥n simple
                const name = parts[0].trim();
                const num = parseInt(parts[1].trim());
                if (!name || isNaN(num) || num < 0) return;
                currentData[name] = num;
                processedCount++;
            });

            if (processedCount > 0) {
                reviewNames(currentData);
                showReview();
                showStatus(`üîç Revisando ${processedCount} registros...`, 'info');
            } else {
                showStatus('‚ùå No se encontraron datos v√°lidos en el texto.', 'error');
            }
        }

        function saveGoal() {
            if (!auth.currentUser) {
                showStatus('‚ùå Debes iniciar sesi√≥n como admin.', 'error');
                return;
            }
            const newGoal = parseInt(document.getElementById('newGoal').value);
            if (isNaN(newGoal) || newGoal < 1000 || newGoal > 100000) {
                showStatus('‚ùå Meta debe estar entre 1,000 y 100,000', 'error');
                return;
            }

            goalDaily = newGoal;
            showUnsavedIndicator();
            renderTable();
            hideConfig();
            showStatus('‚úÖ Meta actualizada correctamente (recuerda guardar en Firebase)', 'success');
        }

        function backupData() {
            if (!auth.currentUser) {
                showStatus('‚ùå Debes iniciar sesi√≥n como admin.', 'error');
                return;
            }

            const dateObj = new Date();
            const dateStr = dateObj.toISOString().split('T')[0];

            // Objeto completo de backup
            const backupState = {
                version: 2, // Versi√≥n del formato de backup
                timestamp: Date.now(),
                dateString: dateStr,
                globalConfig: {
                    goalDaily: goalDaily,
                    lastUpdate: lastUpdate,
                    weekStart: weekStart,
                    totalPlayers: Object.keys(players).length
                },
                players: players // Copia exacta de todo el objeto players
            };

            const jsonString = JSON.stringify(backupState, null, 2); // Pretty print para legibilidad opcional
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            const fileName = `backup_donaciones_FULL_${dateStr}.json`;
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showStatus('‚úÖ Copia de seguridad COMPLETA (.json) descargada.', 'success');
        }

        function restoreBackup(event) {
            if (!auth.currentUser) {
                showStatus('‚ùå Debes iniciar sesi√≥n como admin.', 'error');
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const content = e.target.result;

                try {
                    // INTENTO 1: Restauraci√≥n moderna (JSON)
                    const backupState = JSON.parse(content);

                    if (backupState.players && backupState.globalConfig) {
                        // Es un backup v√°lido JSON V2
                        if (!confirm(`‚ö†Ô∏è Vas a restaurar una copia COMPLETA del ${backupState.dateString || 'desconocida'}.\nEsto sobrescribir√° TODOS los datos actuales.\n¬øContinuar?`)) {
                            event.target.value = '';
                            return;
                        }

                        // Restaurar globales
                        if (backupState.globalConfig.goalDaily) goalDaily = backupState.globalConfig.goalDaily;
                        if (backupState.globalConfig.lastUpdate) lastUpdate = backupState.globalConfig.lastUpdate;
                        if (backupState.globalConfig.weekStart) weekStart = backupState.globalConfig.weekStart;

                        // Restaurar jugadores
                        players = backupState.players;

                        showUnsavedIndicator();
                        renderTable();
                        showStatus('‚úÖ Restauraci√≥n COMPLETA exitosa (Formato JSON).', 'success');
                        event.target.value = '';
                        return;
                    }
                } catch (err) {
                    // No es JSON, intentar legacy
                    console.log('No es JSON v√°lido, intentando formato Legacy TXT...');
                }

                // INTENTO 2: Restauraci√≥n Legacy (TXT)
                // (C√≥digo original para soporte de archivos viejos)
                const lines = content.split('\n');
                if (lines.length < 5) {
                    showStatus('‚ùå Archivo no reconocido o da√±ado.', 'error');
                    return;
                }

                if (!confirm(`‚ö†Ô∏è Detectado formato ANTIGUO (.txt).\nSe intentar√° restaurar, pero algunos detalles (como baneos exactos) podr√≠an perderse.\n¬øContinuar?`)) {
                    event.target.value = '';
                    return;
                }

                const newPlayers = {};
                let currentName = null;
                let currentIndex = -1;

                // L√≥gica legacy simplificada y protegida
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.startsWith('NOMBRE:')) {
                        currentName = line.split(':')[1].trim();
                        if (currentName) newPlayers[currentName] = {};
                    } else if (currentName && newPlayers[currentName]) {
                        const parts = line.split(':');
                        if (parts.length === 2) {
                            const key = parts[0].trim();
                            const value = parts[1].trim();
                            if (key === 'TEN√çA') newPlayers[currentName].previous = parseInt(value) || 0;
                            else if (key === 'TIENE') newPlayers[currentName].current = parseInt(value) || 0;
                            else if (key === 'ACUMULADO') newPlayers[currentName].accumulatedExcess = parseInt(value) || 0;
                            else if (key === 'TOTAL') {
                                newPlayers[currentName].total = parseInt(value) || 0;
                                // Asumimos defaults para legacy
                                newPlayers[currentName].absent = false;
                                newPlayers[currentName].isNew = false;
                            }
                        }
                    }
                }

                players = newPlayers;
                showUnsavedIndicator();
                renderTable();
                showStatus('‚úÖ Restauraci√≥n PARCIAL exitosa (Formato Legacy TXT).', 'success');

                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // --- FUNCIONES DE GUARDADO CENTRALIZADO ---

        function showSaveOptions() {
            if (!auth.currentUser) {
                showStatus('‚ùå Debes iniciar sesi√≥n como admin.', 'error');
                return;
            }
            hideAllSections(); // Asegurar que no haya solapamientos
            document.getElementById('saveOptionsModal').classList.add('active');
        }

        function hideSaveOptions() {
            document.getElementById('saveOptionsModal').classList.remove('active');
        }

        async function executeSave(mode) {
            hideSaveOptions();

            // Verificar si hay datos manuales pendientes (Vista Previa activa)
            const manualText = document.getElementById('manualInput').value.trim();
            let pendingDataProcessed = false;

            if (manualText && mode === 'NEW_WEEK') {
                if (confirm('üìù Hay datos manuales en la vista previa. ¬øQuieres usarlos para cerrar la semana?\n(Si dices Cancelar, se ignorar√°n y se usar√° solo lo que ya estaba guardado)')) {
                    // Procesar datos manuales r√°pidamente
                    const lines = manualText.split('\n');
                    const updates = {};
                    let validLines = 0;

                    lines.forEach(line => {
                        const parts = line.split(',');
                        if (parts.length === 2) {
                            const name = parts[0].trim();
                            const val = parseInt(parts[1].trim());
                            if (name && !isNaN(val) && val >= 0) {
                                updates[name] = val;
                                validLines++;
                            }
                        }
                    });

                    if (validLines > 0) {
                        // Aplicar actualizaciones a `players`
                        updatePlayers(updates); // Reutilizamos la funci√≥n existente que ya maneja la l√≥gica correcta
                        pendingDataProcessed = true;

                        // Limpiar entrada manual y preview
                        document.getElementById('manualInput').value = '';
                        previewData = null;
                        renderTable(); // Refrescar para asegurar que la tabla base est√© al d√≠a antes del cierre
                    }
                }
            }

            if (mode === 'NEW_WEEK') {
                let msg = '‚ö†Ô∏è ¬øEst√°s seguro de CERRAR la semana actual?';
                if (pendingDataProcessed) msg += '\n(Se incluir√°n los datos manuales que acabas de confirmar)';
                msg += '\n\nEsto calcular√° los acumulados finales, reiniciar√° los contadores a cero y guardar√° todo en Firebase.';

                if (!confirm(msg)) {
                    return;
                }
                await startNewWeek();
                await saveData(); // Guardar los cambios post-cierre

                // Asegurar que la vista previa visual se limpie
                clearPreview();
                hidemanualWrapper(); // Funci√≥n helper si existe, o borramos manualmente
                document.getElementById('manualSection').classList.remove('active'); // Ocultar panel manual si estaba abierto

                showStatus('‚úÖ ¬°Semana cerrada y nueva semana iniciada correctamente!', 'success');
            } else {
                // UPDATE
                await saveData();
                showStatus('‚úÖ Datos guardados en Firebase correctamente (Semana actual contin√∫a).', 'success');
            }
        }

        function hidemanualWrapper() {
            document.getElementById('manualInput').value = '';
            previewData = null;
            renderTable();
        }

        // Reemplaza a la antigua funci√≥n manualSave directa
        function manualSave() {
            showSaveOptions();
        }

        // --- MANEJO DE LA INTERFAZ (MODALES, ETC.) ---

        function hideAllSections() {
            document.querySelectorAll('.section, .modal-overlay').forEach(section => {
                section.classList.remove('active');
            });
        }

        function showLogin() {
            hideAllSections();
            document.getElementById('loginSection').classList.add('active');
        }

        function hideLogin() {
            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPass').value = '';
        }

        function showManual() {
            if (!auth.currentUser) return showLogin();
            hideAllSections();
            document.getElementById('manualSection').classList.add('active');
        }

        function hideManual() {
            document.getElementById('manualSection').classList.remove('active');
            document.getElementById('manualInput').value = '';
        }

        function showReview() {
            hideAllSections();
            document.getElementById('reviewSection').classList.add('active');
        }

        function configGoal() {
            if (!auth.currentUser) return showLogin();
            hideAllSections();
            document.getElementById('configSection').classList.add('active');
            document.getElementById('newGoal').value = goalDaily;
        }

        function hideConfig() {
            document.getElementById('configSection').classList.remove('active');
        }

        function showInfo() {
            hideAllSections();
            document.getElementById('infoModal').classList.add('active');
        }

        function hideInfo() {
            document.getElementById('infoModal').classList.remove('active');
        }

        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            if (type === 'success') {
                setTimeout(() => {
                    if (statusDiv.textContent === message) {
                        statusDiv.textContent = '';
                        statusDiv.className = 'status';
                    }
                }, 5000);
            }
        }

        // --- OTROS ---

        // Service Worker con Workbox
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker-v223.js')
                    .then(registration => {
                        console.log('Service Worker registrado con Workbox:', registration);

                        // Detectar nuevas versiones del Service Worker
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('Nueva versi√≥n de Service Worker detectada');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('Nueva versi√≥n lista para activar.');
                                    hasAppUpdate = true;
                                    toggleSmartSyncIndicator(true);
                                    showStatus('üöÄ Nueva versi√≥n disponible. Toca üîÑ para actualizar.', 'success');
                                }
                            });
                        });

                        // Asegurar que el Service Worker tome control inmediatamente
                        if (registration.waiting) {
                            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                        }
                    })
                    .catch(err => {
                        console.error('Error registrando Service Worker:', err);
                    });
            });

            // Escuchar mensajes del Service Worker
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'SKIP_WAITING') {
                    console.log('Mensaje SKIP_WAITING recibido del Service Worker');
                }
            });
        }

        // Cargar preferencias guardadas
        loadNotificationPreference();

        // Listener para instalaci√≥n de PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installBtn = document.getElementById('installBtn');
            if (installBtn) {
                installBtn.style.display = 'block';
                installBtn.textContent = 'üì± Instalar App';
            }
        });

        window.addEventListener('appinstalled', () => {
            console.log('App instalada correctamente');
            deferredPrompt = null;
            const installBtn = document.getElementById('installBtn');
            if (installBtn) {
                installBtn.style.display = 'none';
            }
            showStatus('‚úÖ App instalada en tu dispositivo', 'success');
        });

        // Prevenir zoom en doble tap en m√≥viles
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>

    <!-- === FUNCIONES DE VISTA PREVIA === -->
    <script>
        function updatePreviewForEditing() {
            if (!editingPlayer || typeof auth === 'undefined' || !auth.currentUser) return;

            const newPrevInput = document.getElementById(`edit-previous-${editingPlayer}`);
            const newCurrInput = document.getElementById(`edit-current-${editingPlayer}`);

            if (!newPrevInput || !newCurrInput) return;

            const newPrev = parseInt(newPrevInput.value) || 0;
            const newCurr = parseInt(newCurrInput.value) || 0;

            // Crear el jugador con los nuevos valores para calcular el futuro estado
            const previewPlayer = {
                ...players[editingPlayer],
                previous: newPrev,
                current: newCurr,
                accumulatedExcess: (document.getElementById(`edit-accumulated-${editingPlayer}`) ? parseInt(document.getElementById(`edit-accumulated-${editingPlayer}`).value) : players[editingPlayer].accumulatedExcess)
            };

            // Calcular el total: si hay aumento en current, se suma al total
            const currentDiff = newCurr - (players[editingPlayer].current || 0);
            if (currentDiff > 0) {
                previewPlayer.total = (players[editingPlayer].total || 0) + currentDiff;
            }

            // Actualizar previewData
            previewData = { [editingPlayer]: previewPlayer };

            // Volver a renderizar para mostrar la preview
            renderTable();
        }

        function clearPreview() {
            previewData = null;
            renderTable();
        }

        function updateManualPreview() {
            if (typeof auth === 'undefined' || !auth.currentUser) return;

            const text = document.getElementById('manualInput').value.trim();
            if (!text) {
                clearPreview();
                return;
            }

            const lines = text.split('\n');
            const currentData = {};
            let hasError = false;

            for (let index = 0; index < lines.length; index++) {
                const line = lines[index].trim();
                if (!line) continue;

                const parts = line.split(',');
                if (parts.length !== 2) {
                    hasError = true;
                    break;
                }

                const name = parts[0].trim();
                const num = parseInt(parts[1].trim());

                if (!name || isNaN(num) || num < 0) {
                    hasError = true;
                    break;
                }

                currentData[name] = num;
            }

            if (hasError) {
                clearPreview();
                return;
            }

            // Calcular preview para todos los jugadores mencionados
            previewData = {};

            Object.keys(currentData).forEach(name => {
                const newCurrent = currentData[name];

                if (!players[name]) {
                    // Nuevo jugador: se inicia con previous=0, current=valor ingresado
                    // Al ser nuevo, la donaci√≥n semanal es todo el valor ingresado
                    previewData[name] = {
                        previous: 0,
                        current: newCurrent,
                        total: newCurrent, // Total = donaci√≥n de esta semana
                        weeklyTotal: newCurrent,
                        accumulatedExcess: 0,
                        isNew: true,
                        absent: false,
                        willBeBanned: false
                    };
                } else {
                    // Jugador existente
                    const player = players[name];
                    const previousCurrent = player.current || 0;

                    // Si el nuevo valor es menor que el actual, hay error (no deber√≠a pasar)
                    if (newCurrent < previousCurrent) {
                        console.warn(`‚ö†Ô∏è Error en preview: ${name} tiene valor menor (${newCurrent} < ${previousCurrent})`);
                        return;
                    }

                    const difference = newCurrent - previousCurrent;

                    // --- SIMULACI√ìN MULTI-ETAPA ---

                    const weeklyGoal = (goalDaily || 0) * 7;

                    // PASO 1: Simular el cierre de la SEMANA ACTUAL (Week A)
                    // Usamos los valores actuales expl√≠citos para evitar inconsistencias
                    const currentWeeklyDonation = (player.current || 0) - (player.previous || 0);

                    // Importante: Usar Math.max(0, ...) para el acumulado hist√≥rico, igual que en renderTable
                    let baseAccumulated = Math.max(0, player.accumulatedExcess || 0);

                    if (currentWeeklyDonation >= weeklyGoal) {
                        // Super√°vit en Week A
                        baseAccumulated += (currentWeeklyDonation - weeklyGoal);
                    } else {
                        // D√©ficit en Week A
                        const deficitA = Math.max(0, weeklyGoal - currentWeeklyDonation);
                        const availableA = baseAccumulated;
                        const drawA = Math.min(deficitA, availableA);
                        baseAccumulated = availableA - drawA;
                    }

                    // PASO 2: Proyectar la SEMANA SIGUIENTE (Week B - Vista Previa)
                    // Usamos 'baseAccumulated' como el punto de partida real (lo que el usuario ve como "Acumulado" hoy)
                    const futureDonation = difference; // Lo donado en la nueva semana (Week B)
                    let finalAccumulated = baseAccumulated;
                    let futureDeficitDraw = 0;

                    if (futureDonation >= weeklyGoal) {
                        finalAccumulated += (futureDonation - weeklyGoal);
                    } else {
                        const deficitB = weeklyGoal - futureDonation;
                        const availableB = Math.max(0, finalAccumulated);
                        futureDeficitDraw = Math.min(deficitB, availableB);
                        finalAccumulated = availableB - futureDeficitDraw;
                    }

                    previewData[name] = {
                        ...player,
                        previous: previousCurrent, // El valor "ten√≠a" se mantiene como referencia visual
                        current: newCurrent, // El nuevo valor ingresado
                        total: (player.total || 0) + difference, // Total aumenta por la diferencia
                        weeklyTotal: futureDonation, // Donaci√≥n de la nueva semana
                        accumulatedExcess: finalAccumulated, // Valor final tras las dos etapas
                        isNew: false,
                        absent: false,
                        willBeBanned: false,
                        simulatedDeficitDraw: futureDeficitDraw // Solo lo que se descont√≥ en la Week B
                    };
                }
            });

            // Identificar jugadores que ser√°n baneados (no aparecen en currentData pero s√≠ existen)
            Object.keys(players).forEach(name => {
                if (!currentData[name] && !players[name].absent) {
                    // Este jugador ser√° marcado como ausente/baneado
                    previewData[name] = {
                        ...players[name],
                        isNew: false,
                        absent: true,
                        willBeBanned: true
                    };
                }
            });

            renderTable();
        }
    </script>

    <!-- Firebase App (el n√∫cleo) -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore (la base de datos) -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</body>

</html>